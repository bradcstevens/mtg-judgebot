from langchain.tools import BaseTool
from langchain_openai import ChatOpenAI
from langchain.schema import HumanMessage, SystemMessage
import json
from pydantic import BaseModel, Field


class GameStateConstructor(BaseTool):
    name: str = "game_state_constructor"
    description: str = "Constructs a detailed representation of the Magic: The Gathering game state from the user's query. Use this if query involves complicatedchanges in game state."
    model: ChatOpenAI = Field(default_factory=lambda: ChatOpenAI(model_name='gpt-4', temperature=0))


    def __init__(self):
        super().__init__()
        self.model = ChatOpenAI(model_name='gpt-4o', temperature=0)

    def _run(self, query: str) -> str:
        game_state = self.construct_game_state(query)
        return json.dumps(game_state)

    def construct_game_state(self, query: str) -> dict:
        system_prompt = """You are a program that is taking a user's query and information about Magic: The Gathering cards and rules and converting it into a set of instructions for a game engine to execute.

You will use the following rules of Magic: The Gathering to create this set of instructions for the game engine to execute.

117. Timing and Priority
117.1. Unless a spell or ability is instructing a player to take an action, which player can take actions at any given time is determined by a system of priority. The player with priority may cast spells, activate abilities, and take special actions.
117.1a A player may cast an instant spell any time they have priority. A player may cast a noninstant spell during their main phase any time they have priority and the stack is empty.
117.1b A player may activate an activated ability any time they have priority.
117.1c A player may take some special actions any time they have priority. A player may take other special actions during their main phase any time they have priority and the stack is empty. See rule 116, "Special Actions."
117.1d A player may activate a mana ability whenever they have priority, whenever they are casting a spell or activating an ability that requires a mana payment, or whenever a rule or effect asks for a mana payment (even in the middle of casting or resolving a spell or activating or resolving an ability).
117.2. Other kinds of abilities and actions are automatically generated or performed by the game rules, or are performed by players without receiving priority.
117.2a Triggered abilities can trigger at any time, including while a spell is being cast, an ability is being activated, or a spell or ability is resolving. (See rule 603, "Handling Triggered Abilities.") However, nothing actually happens at the time an ability triggers. Each time a player would receive priority, each ability that has triggered but hasn't yet been put on the stack is put on the stack. See rule 117.5.
117.2b Static abilities continuously affect the game. Priority doesn't apply to them. (See rule 604, "Handling Static Abilities," and rule 611, "Continuous Effects.")
117.2c Turn-based actions happen automatically when certain steps or phases begin. They're dealt with before a player would receive priority. See rule 117.3a. Turn-based actions also happen automatically when each step and phase ends; no player receives priority afterward. See rule 703, "Turn-Based Actions."
117.2d State-based actions happen automatically when certain conditions are met. See rule 704. They're dealt with before a player would receive priority. See rule 117.5.
117.2e Resolving spells and abilities may instruct players to make choices or take actions, or may allow players to activate mana abilities. Even if a player is doing so, no player has priority while a spell or ability is resolving. See rule 608, "Resolving Spells and Abilities."
117.3. Which player has priority is determined by the following rules:
117.3a The active player receives priority at the beginning of most steps and phases, after any turn-based actions (such as drawing a card during the draw step; see rule 703) have been dealt with and abilities that trigger at the beginning of that phase or step have been put on the stack. No player receives priority during the untap step. Players usually don't get priority during the cleanup step (see rule 514.3).
117.3b The active player receives priority after a spell or ability (other than a mana ability) resolves.
117.3c If a player has priority when they cast a spell, activate an ability, or take a special action, that player receives priority afterward.
117.3d If a player has priority and chooses not to take any actions, that player passes. If any mana is in that player's mana pool, they announce what mana is there. Then the next player in turn order receives priority.
117.4. If all players pass in succession (that is, if all players pass without taking any actions in between passing), the spell or ability on top of the stack resolves or, if the stack is empty, the phase or step ends.
117.5. Each time a player would get priority, the game first performs all applicable state-based actions as a single event (see rule 704, "State-Based Actions"), then repeats this process until no state-based actions are performed. Then triggered abilities are put on the stack (see rule 603, "Handling Triggered Abilities"). These steps repeat in order until no further state-based actions are performed and no abilities trigger. Then the player who would have received priority does so.
117.6. In a multiplayer game using the shared team turns option, teams rather than individual players have priority. See rule 805, "Shared Team Turns Option."
117.7. If a player with priority casts a spell or activates an activated ability while another spell or ability is already on the stack, the new spell or ability has been cast or activated "in response to" the earlier spell or ability. The new spell or ability will resolve first. See rule 608, "Resolving Spells and Abilities."

405. Stack
405.1. When a spell is cast, the physical card is put on the stack (see rule 601.2a). When an ability is activated or triggers, it goes on top of the stack without any card associated with it (see rules 602.2a and 603.3).
405.2. The stack keeps track of the order that spells and/or abilities were added to it. Each time an object is put on the stack, it's put on top of all objects already there.
405.3. If an effect puts two or more objects on the stack at the same time, those controlled by the active player are put on lowest, followed by each other player's objects in APNAP order (see rule 101.4). If a player controls more than one of these objects, that player chooses their relative order on the stack.
405.4. Each spell has all the characteristics of the card associated with it. Each activated or triggered ability that's on the stack has the text of the ability that created it and no other characteristics. The controller of a spell is the person who cast it. The controller of an activated ability is the player who activated it. The controller of a triggered ability is the player who controlled the ability's source when it triggered, unless it's a delayed triggered ability. To determine the controller of a delayed triggered ability, see rules 603.7d-f.
405.5. When all players pass in succession, the top (last-added) spell or ability on the stack resolves. If the stack is empty when all players pass, the current step or phase ends and the next begins.
405.6. Some things that happen during the game don't use the stack.
405.6a Effects don't go on the stack; they're the result of spells and abilities resolving. Effects may create delayed triggered abilities, however, and these may go on the stack when they trigger (see rule 603.7).
405.6b Static abilities continuously generate effects and don't go on the stack. (See rule 604, "Handling Static Abilities.") This includes characteristic-defining abilities such as "[This object] is red" (see rule 604.3).
405.6c Mana abilities resolve immediately. If a mana ability both produces mana and has another effect, the mana is produced and the other effect happens immediately. If a player had priority before a mana ability was activated, that player gets priority after it resolves. (See rule 605, "Mana Abilities.")
405.6d Special actions don't use the stack; they happen immediately. See rule 116, "Special Actions."
405.6e Turn-based actions don't use the stack; they happen automatically when certain steps or phases begin. They're dealt with before a player would receive priority (see rule 117.3a). Turn-based actions also happen automatically when each step and phase ends; no player receives priority afterward. See rule 703.
405.6f State-based actions don't use the stack; they happen automatically when certain conditions are met. See rule 704. They are dealt with before a player would receive priority. See rule 117.5.
405.6g A player may concede the game at any time. That player leaves the game immediately. See rule 104.3a.
405.6h If a player leaves a multiplayer game, objects may leave the game, cease to exist, change control, or be exiled as a result. These actions happen immediately. See rule 800.4a.

5. Turn Structure

500. General
500.1. A turn consists of five phases, in this order: beginning, precombat main, combat, postcombat main, and ending. Each of these phases takes place every turn, even if nothing happens during the phase. The beginning, combat, and ending phases are further broken down into steps, which proceed in order.
500.2. A phase or step in which players receive priority ends when the stack is empty and all players pass in succession. Simply having the stack become empty doesn't cause such a phase or step to end; all players have to pass in succession with the stack empty. Because of this, each player gets a chance to add new things to the stack before that phase or step ends.
500.3. A step in which no players receive priority ends when all specified actions that take place during that step are completed. The only such steps are the untap step (see rule 502) and certain cleanup steps (see rule 514).
500.4. When a step or phase ends, any unused mana left in a player's mana pool empties. This turn-based action doesn't use the stack.
500.5. When a phase or step ends, any effects scheduled to last "until end of" that phase or step expire. When a phase or step begins, any effects scheduled to last "until" that phase or step expire. Effects that last "until end of combat" expire at the end of the combat phase, not at the beginning of the end of combat step. Effects that last "until end of turn" are subject to special rules; see rule 514.2.
500.6. When a phase or step begins, any abilities that trigger "at the beginning of" that phase or step trigger. They are put on the stack the next time a player would receive priority. (See rule 117, "Timing and Priority.")
500.7. Some effects can give a player extra turns. They do this by adding the turns directly after the specified turn. If a player is given multiple extra turns, the extra turns are added one at a time. If multiple players are given extra turns, the extra turns are added one at a time, in APNAP order (see rule 101.4). The most recently created turn will be taken first.
500.8. Some effects can add phases to a turn. They do this by adding the phases directly after the specified phase. If multiple extra phases are created after the same phase, the most recently created phase will occur first.
500.9. Some effects can add steps to a phase. They do this by adding the steps directly after a specified step or directly before a specified step. If multiple extra steps are created after the same step, the most recently created step will occur first.
500.10. Some effects add a step after a particular phase. In that case, that effect first creates the phase which normally contains that step directly after the specified phase. Any other steps that phase would normally have are skipped (see rule 500.11).
Example: Obeka, Splitter of Seconds says, in part, "Whenever Obeka, Splitter of Seconds deals combat damage to a player, you get that many additional upkeep steps after this phase." After that ability resolves, its controller adds that many beginning phases after this phase. Those new beginning phases have only an upkeep step. The untap steps and draw steps of those phases are skipped.
500.10a If an effect that says "you get" an additional step or phase would add a step or phase to a turn other than its controller's, no steps or phases are added.
500.11. Some effects can cause a step, phase, or turn to be skipped. To skip a step, phase, or turn is to proceed past it as though it didn't exist. See rule 614.10.
500.12. No game events can occur between steps, phases, or turns.

501. Beginning Phase
501.1. The beginning phase consists of three steps, in this order: untap, upkeep, and draw.

502. Untap Step
502.1. First, all phased-in permanents with phasing that the active player controls phase out, and all phased-out permanents that the active player controlled when they phased out phase in. This all happens simultaneously. This turn-based action doesn't use the stack. See rule 702.26, "Phasing."
502.2. Second, if it's day and the previous turn's active player didn't cast any spells during that turn, it becomes night. If it's night and the previous turn's active player cast two or more spells during that turn, it becomes day. If it's neither day nor night, this check doesn't happen and it remains neither. This turn-based action doesn't use the stack. See rule 727, "Day and Night."
502.2a Multiplayer games using the shared team turns option use a modified rule. If it's day and no player on the previous turn's active team cast a spell during that turn, it becomes night. If it's night and any player on the previous turn's active team cast two or more spells during the previous turn, it becomes day. If it's neither day nor night, this check doesn't happen and it remains neither. This turn-based action doesn't use the stack.
502.3. Third, the active player determines which permanents they control will untap. Then they untap them all simultaneously. This turn-based action doesn't use the stack. Normally, all of a player's permanents untap, but effects can keep one or more of a player's permanents from untapping.
502.4. No player receives priority during the untap step, so no spells can be cast or resolve and no abilities can be activated or resolve. Any ability that triggers during this step will be held until the next time a player would receive priority, which is usually during the upkeep step. (See rule 503, "Upkeep Step.")

503. Upkeep Step
503.1. The upkeep step has no turn-based actions. Once it begins, the active player gets priority. (See rule 117, "Timing and Priority.")
503.1a Any abilities that triggered during the untap step and any abilities that triggered at the beginning of the upkeep are put onto the stack before the active player gets priority; the order in which they triggered doesn't matter. (See rule 603, "Handling Triggered Abilities.")
503.2. If a spell states that it may be cast only "after [a player's] upkeep step," and the turn has multiple upkeep steps, that spell may be cast any time after the first upkeep step ends.

504. Draw Step
504.1. First, the active player draws a card. This turn-based action doesn't use the stack.
504.2. Second, the active player gets priority. (See rule 117, "Timing and Priority.")

505. Main Phase
505.1. There are two main phases in a turn. In each turn, the first main phase (also known as the precombat main phase) and the second main phase (also known as the postcombat main phase) are separated by the combat phase (see rule 506, "Combat Phase"). The precombat and postcombat main phases are individually and collectively known as the main phase.
505.1a Only the first main phase of the turn is a precombat main phase. All other main phases are postcombat main phases. This includes the second main phase of a turn in which the combat phase has been skipped. It is also true of a turn in which an effect has caused an additional combat phase and an additional main phase to be created.
505.1b In card text, phrases such as "first main phase," "second main phase," and so on count the number of main phases that have occurred only in the current turn unless that text specifies otherwise.
505.2. The main phase has no steps, so a main phase ends when all players pass in succession while the stack is empty. (See rule 500.2.)
505.3. First, but only if the players are playing an Archenemy game (see rule 904), the active player is the archenemy, and it's the active player's precombat main phase, the active player sets the top card of their scheme deck in motion (see rule 701.25). This turn-based action doesn't use the stack.
505.4. Second, if the active player controls one or more Saga enchantments and it's the active player's precombat main phase, the active player puts a lore counter on each Saga they control. (See rule 714, "Saga Cards."). This turn-based action doesn't use the stack.
505.5. Third, if the active player controls one or more Attractions and it's the active player's precombat main phase, the active player rolls to visit their Attractions. (See rule 701.49, "Roll to Visit Your Attractions."). This turn-based action doesn't use the stack.
505.6. Fourth, the active player gets priority. (See rule 117, "Timing and Priority.")
505.6a The main phase is the only phase in which a player can normally cast artifact, creature, enchantment, planeswalker, and sorcery spells. The active player may cast these spells.
505.6b During either main phase, the active player may play one land card from their hand if the stack is empty, if the player has priority, and if they haven't played a land this turn (unless an effect states the player may play additional lands). This action doesn't use the stack. Neither the land nor the action of playing the land is a spell or ability, so it can't be countered, and players can't respond to it with instants or activated abilities. (See rule 305, "Lands.")

506. Combat Phase
506.1. The combat phase has five steps, which proceed in order: beginning of combat, declare attackers, declare blockers, combat damage, and end of combat. The declare blockers and combat damage steps are skipped if no creatures are declared as attackers or put onto the battlefield attacking (see rule 508.8). There are two combat damage steps if any attacking or blocking creature has first strike (see rule 702.7) or double strike (see rule 702.4).
506.2. During the combat phase, the active player is the attacking player; creatures that player controls may attack. During the combat phase of a two-player game, the nonactive player is the defending player; that player, planeswalkers they control, and battles they protect may be attacked.
506.2a During the combat phase of a multiplayer game, there may be one or more defending players, depending on the variant being played and the options chosen for it. Unless all the attacking player's opponents automatically become defending players during the combat phase, the attacking player chooses one of their opponents as a turn-based action during the beginning of combat step. (Note that the choice may be dictated by the variant being played or the options chosen for it.) That player becomes the defending player. See rule 802, "Attack Multiple Players Option," rule 803, "Attack Left and Attack Right Options," and rule 809, "Emperor Variant."
506.2b In multiplayer games using the shared team turns option, the active team is the attacking team and the nonactive team is the defending team. See rule 805, "Shared Team Turns Option."
506.3. Only a creature can attack or block. Only a player, a planeswalker, or a battle can be attacked.
506.3a If an effect would put a noncreature permanent onto the battlefield attacking or blocking, the permanent does enter the battlefield but it's never considered to be an attacking or blocking permanent.
506.3b If an effect would put a creature onto the battlefield attacking under the control of any player except an attacking player, that creature does enter the battlefield, but it's never considered to be an attacking creature.
506.3c If an effect would put a creature onto the battlefield attacking either a player not in the game or a permanent that's no longer on the battlefield or isn't either a planeswalker or a battle, that creature does enter the battlefield, but it's never considered to be an attacking creature.
506.3d If an effect would put a creature onto the battlefield blocking but the creature it would block isn't attacking the entering creature's controller, a planeswalker that player controls, or a battle that player protects, that creature does enter the battlefield, but it's never considered to be a blocking creature.
506.3e If an effect would put a creature that's also a battle onto the battlefield attacking or blocking, that permanent enters the battlefield but it's never considered to be an attacking or blocking creature.
506.3f If a resolving spell or ability would cause a battle to become an attacking or blocking creature, that part of the effect does nothing.
506.4. A permanent is removed from combat if it leaves the battlefield, if its controller changes, if it phases out, if an effect specifically removes it from combat, if it's a planeswalker that's being attacked and stops being a planeswalker, if it's a battle that's being attacked and stops being a battle, or if it's an attacking or blocking creature that regenerates (see rule 701.15), stops being a creature, or becomes a battle. A creature that's removed from combat stops being an attacking, blocking, blocked, and/or unblocked creature. A planeswalker or battle that's removed from combat stops being attacked.
506.4a Once a creature has been declared as an attacking or blocking creature, spells or abilities that would have kept that creature from attacking or blocking don't remove the creature from combat.
506.4b Tapping or untapping a creature that's already been declared as an attacker or blocker doesn't remove it from combat and doesn't prevent its combat damage.
506.4c If a creature is attacking a planeswalker or battle, removing that planeswalker or battle from combat doesn't remove that creature from combat. It continues to be an attacking creature, although it is not attacking any player, planeswalker, or battle. It may be blocked. If it is unblocked, it will deal no combat damage.
506.4d A permanent that's both a blocking creature and a planeswalker that's being attacked is removed from combat if it stops being both a creature and a planeswalker. If it stops being one of those card types but continues to be the other, it continues to be either a blocking creature or a planeswalker that's being attacked, whichever is appropriate.
506.4e A permanent that's being attacked that is both a planeswalker and a battle is removed from combat if it stops being both a planeswalker and a battle. If it stops being a battle but is still a planeswalker, it is removed from combat only if it is not controlled by its protector. If it stops being a planeswalker but is still a battle, it is not removed from combat. It continues to be a battle that's being attacked.
506.5. A creature attacks alone if it's the only creature declared as an attacker during the declare attackers step. A creature is attacking alone if it's attacking but no other creatures are. A creature blocks alone if it's the only creature declared as a blocker during the declare blockers step. A creature is blocking alone if it's blocking but no other creatures are.
506.6. Some abilities check to see whether or not a creature "had to attack" during a particular combat phase. A creature had to attack if one or more effects were requiring that creature to attack at the time attackers were declared in that combat. A creature did not "have to attack" if there were no such effects that required it to attack, even if there were no other legal attacks that could have been declared. (See rule 508.)
506.7. Some spells state that they may be cast "only [before/after] [a particular point in the combat phase], " in which that point may be "attackers are declared," "blockers are declared," "the combat damage step," "the end of combat step," "the combat phase," or "combat."
506.7a A spell that states it may be cast "only before (or after) attackers are declared" is referring to the turn-based action of declaring attackers. It may be cast only before (or after) the declare attackers step begins, regardless of whether any attackers are actually declared. (See rule 508.)
506.7b A spell that states it may be cast "only before (or after) blockers are declared" is referring to the turn-based action of declaring blockers. It may be cast only before (or after) the declare blockers step begins, regardless of whether any blockers are actually declared. (See rule 509.)
506.7c Some spells state that they may be cast "only during combat" or "only during a certain player's combat phase" in addition to the criteria described in rule 506.7. If a turn has multiple combat phases, such spells may be cast at an appropriate time during any of them.
506.7d Some spells state that they may be cast "only before (or after) [a particular point in the combat phase], " but don't meet the additional criteria described in rule 506.7c. If a turn has multiple combat phases, such spells may be cast that turn only before (or after) the stated point of the first combat phase.
506.7e If a spell states that it may be cast "only before [a particular point in the combat phase], " but the stated point doesn't exist within the relevant combat phase because the declare blockers step and the combat damage step are skipped (see rule 508.8), then the spell may be cast only before the declare attackers step ends. If the stated point doesn't exist because the relevant combat phase has been skipped, then the spell may be cast only before the precombat main phase ends.
506.7f If a spell states that it may be cast "only during combat after blockers are declared," but the declare blockers step is skipped that combat phase (see rule 508.8), then the spell may not be cast during that combat phase.
506.7g Rules 506.7 and 506.7a-f apply to abilities that state that they may be activated only at certain times with respect to combat just as they apply to spells that state that they may be cast only at certain times with respect to combat.

507. Beginning of Combat Step
507.1. First, if the game being played is a multiplayer game in which the active player's opponents don't all automatically become defending players, the active player chooses one of their opponents. That player becomes the defending player. This turn-based action doesn't use the stack. (See rule 506.2.)
507.2. Second, the active player gets priority. (See rule 117, "Timing and Priority.")

508. Declare Attackers Step
508.1. First, the active player declares attackers. This turn-based action doesn't use the stack. To declare attackers, the active player follows the steps below, in order. If at any point during the declaration of attackers, the active player is unable to comply with any of the steps listed below, the declaration is illegal; the game returns to the moment before the declaration (see rule 730, "Handling Illegal Actions").
508.1a The active player chooses which creatures that they control, if any, will attack. The chosen creatures must be untapped, they can't also be battles, and each one must either have haste or have been controlled by the active player continuously since the turn began.
508.1b If the defending player controls any planeswalkers, is the protector of any battles, or the game allows the active player to attack multiple other players, the active player announces which player, planeswalker, or battle each of the chosen creatures is attacking.
508.1c The active player checks each creature they control to see whether it's affected by any restrictions (effects that say a creature can't attack, or that it can't attack unless some condition is met). If any restrictions are being disobeyed, the declaration of attackers is illegal.
Example: A player controls two creatures, each with a restriction that states "This creature can't attack alone." It's legal to declare both as attackers.
508.1d The active player checks each creature they control to see whether it's affected by any requirements (effects that say a creature attacks if able, or that it attacks if some condition is met). If the number of requirements that are being obeyed is fewer than the maximum possible number of requirements that could be obeyed without disobeying any restrictions, the declaration of attackers is illegal. If a creature can't attack unless a player pays a cost, that player is not required to pay that cost, even if attacking with that creature would increase the number of requirements being obeyed. If a requirement that says a creature attacks if able during a certain turn refers to a turn with multiple combat phases, the creature attacks if able during each declare attackers step in that turn.
Example: A player controls two creatures: one that "attacks if able" and one with no abilities. An effect states "No more than one creature can attack each turn." The only legal attack is for just the creature that "attacks if able" to attack. It's illegal to attack with the other creature, attack with both, or attack with neither.
508.1e If any of the chosen creatures have banding or a "bands with other" ability, the active player announces which creatures, if any, are banded with which. (See rule 702.22, "Banging.")
508.1f The active player taps the chosen creatures. Tapping a creature when it's declared as an attacker isn't a cost; attacking simply causes creatures to become tapped.
508.1g If there are any optional costs to attack with the chosen creatures (expressed as costs a player may pay "as" a creature attacks), the active player chooses which, if any, they will pay.
508.1h If any of the chosen creatures require paying costs to attack, or if any optional costs to attack were chosen, the active player determines the total cost to attack. Costs may include paying mana, tapping permanents, sacrificing permanents, discarding cards, and so on. Once the total cost is determined, it becomes "locked in." If effects would change the total cost after this time, ignore this change.
508.1i If any of the costs require mana, the active player then has a chance to activate mana abilities (see rule 605, "Mana Abilities").
508.1j Once the player has enough mana in their mana pool, they pay all costs in any order. Partial payments are not allowed.
508.1k Each chosen creature still controlled by the active player becomes an attacking creature. It remains an attacking creature until it's removed from combat or the combat phase ends, whichever comes first. See rule 506.4.
508.1m Any abilities that trigger on attackers being declared trigger.
508.2. Second, the active player gets priority. (See rule 117, "Timing and Priority.")
508.2a Abilities that trigger on a creature attacking trigger only at the point the creature is declared as an attacker. They will not trigger if a creature attacks and then that creature's characteristics change to match the ability's trigger condition.
Example: A permanent has the ability "Whenever a green creature attacks, destroy that creature at end of combat." If a blue creature attacks and is later turned green, the ability will not trigger.
508.2b Any abilities that triggered on attackers being declared or that triggered during the process described in rules 508.1 are put onto the stack before the active player gets priority; the order in which they triggered doesn't matter. (See rule 603, "Handling Triggered Abilities.")
508.3. Triggered abilities that trigger on attackers being declared may have different trigger conditions.
508.3a An ability that reads "Whenever [a creature] attacks, . . . " triggers if that creature is declared as an attacker. Similarly, "Whenever [a creature] attacks [a player, planeswalker, or battle], . . . " triggers if that creature is declared as an attacker attacking that player or permanent. Such abilities won't trigger if a creature is put onto the battlefield attacking.
508.3b An ability that reads "Whenever [a player, planeswalker, or battle] is attacked, . . . " triggers if one or more creatures are declared as attackers attacking that player or permanent. It won't trigger if a creature is put onto the battlefield attacking that player or permanent.
508.3c An ability that reads "Whenever [a player] attacks with [a creature], . . . " triggers if a creature that player controls is declared as an attacker.
508.3d An ability that reads "Whenever [a player] attacks, . . . " triggers if one or more creatures that player controls are declared as attackers.
508.3e An ability that reads "Whenever [a player] attacks [another player], . . . " triggers if one or more creatures the first player controls are declared as attackers attacking the second player. It won't trigger if a creature is put onto the battlefield attacking or if a creature attacks a planeswalker or a battle.
508.3f An ability that reads "Whenever [a creature] attacks and isn't blocked, . . . " triggers during the declare blockers step, not the declare attackers step. See rule 509.5g.
508.4. If a creature is put onto the battlefield attacking, its controller chooses which defending player, planeswalker a defending player controls, or battle a defending player protects it's attacking as it enters the battlefield (unless the effect that put it onto the battlefield specifies what it's attacking). Similarly, if an effect states that a creature is attacking, its controller chooses which defending player, planeswalker a defending player controls, or battle a defending player protects it's attacking (unless the effect has already specified). Such creatures are "attacking" but, for the purposes of trigger events and effects, they never "attacked."
508.4a If the effect that puts a creature onto the battlefield attacking specifies it's attacking a certain player, and that player is no longer in the game when the effect resolves, the creature is put onto the battlefield but is never considered an attacking creature. The same is true if the effect specifies a creature is put onto the battlefield attacking a planeswalker or battle and that permanent is no longer on the battlefield or is no longer a planeswalker or battle when the effect resolves.
508.4b If the effect that states a creature is attacking specifies it's attacking a certain player, and that player is no longer in the game when the effect resolves, the creature doesn't become an attacking creature. The same is true if the effect specifies a creature is attacking a planeswalker or battle and that permanent is no longer on the battlefield or is no longer a planeswalker or battle when the effect resolves.
508.4c A creature that's put onto the battlefield attacking or that is stated to be attacking isn't affected by requirements or restrictions that apply to the declaration of attackers.
508.5. If a creature is put onto the battlefield attacking, its controller chooses which defending player, planeswalker a defending player controls, or battle a defending player protects it's attacking as it enters the battlefield (unless the effect that put it onto the battlefield specifies what it's attacking). Similarly, if an effect states that a creature is attacking, its controller chooses which defending player, planeswalker a defending player controls, or battle a defending player protects it's attacking (unless the effect has already specified). Such creatures are "attacking" but, for the purposes of trigger events and effects, they never "attacked."
508.5a If the effect that puts a creature onto the battlefield attacking specifies it's attacking a certain player, and that player is no longer in the game when the effect resolves, the creature is put onto the battlefield but is never considered an attacking creature. The same is true if the effect specifies a creature is put onto the battlefield attacking a planeswalker or battle and that permanent is no longer on the battlefield or is no longer a planeswalker or battle when the effect resolves.
508.5b If the effect that states a creature is attacking specifies it's attacking a certain player, and that player is no longer in the game when the effect resolves, the creature doesn't become an attacking creature. The same is true if the effect specifies a creature is attacking a planeswalker or battle and that permanent is no longer on the battlefield or is no longer a planeswalker or battle when the effect resolves.
508.5c A creature that's put onto the battlefield attacking or that is stated to be attacking isn't affected by requirements or restrictions that apply to the declaration of attackers.
508.6. A player is "attacking [a player]" if the first player controls a creature that is attacking the second player. A player has "attacked [a player]" if the first player declared one or more creatures as attackers attacking the second player.
508.7. Some cards allow a player to reselect which player, planeswalker, or battle a creature is attacking.
508.7a The attacking creature isn't removed from combat and it isn't considered to have attacked a second time. That creature is attacking the reselected player or permanent, but it's still considered to have attacked the player or permanent chosen as it was declared as an attacker.
508.7b While reselecting which player, planeswalker, or battle a creature is attacking, that creature isn't affected by requirements or restrictions that apply to the declaration of attackers.
508.7c The reselected player, planeswalker, or battle must be an opponent of the attacking creature's controller, a planeswalker controlled by an opponent of the attacking creature's controller, or a battle protected by an opponent of the attacking creature's controller.
508.7d In a multiplayer game not using the attack multiple players option (see rule 802), the reselected player, planeswalker, or battle must be the chosen defending player, a planeswalker controlled by that player, or a battle protected by that player.
508.7e In a multiplayer game using the limited range of influence option (see rule 801), the reselected player, planeswalker, or battle must be within the range of influence of the attacking creature's controller. In the case of a battle, the battle's protector must also be within the range of influence of the attacking creature's controller.
508.8. If no creatures are declared as attackers or put onto the battlefield attacking, skip the declare blockers and combat damage steps.

509. Declare Blockers Step
509.1. First, the defending player declares blockers. This turn-based action doesn't use the stack. To declare blockers, the defending player follows the steps below, in order. If at any point during the declaration of blockers, the defending player is unable to comply with any of the steps listed below, the declaration is illegal; the game returns to the moment before the declaration (see rule 730, “Handling Illegal Actions”).
509.1a The defending player chooses which creatures they control, if any, will block. The chosen creatures must be untapped and they can't also be battles. For each of the chosen creatures, the defending player chooses one creature for it to block that's attacking that player, a planeswalker they control, or a battle they protect.
509.1b The defending player checks each creature they control to see whether it's affected by any restrictions (effects that say a creature can't block, or that it can't block unless some condition is met). If any restrictions are being disobeyed, the declaration of blockers is illegal.
    A restriction may be created by an evasion ability (a static ability an attacking creature has that restricts what can block it). If an attacking creature gains or loses an evasion ability after a legal block has been declared, it doesn't affect that block. Different evasion abilities are cumulative.
    Example: An attacking creature with flying and shadow can't be blocked by a creature with flying but without shadow.
509.1c The defending player checks each creature they control to see whether it's affected by any requirements (effects that say a creature must block, or that it must block if some condition is met). If the number of requirements that are being obeyed is fewer than the maximum possible number of requirements that could be obeyed without disobeying any restrictions, the declaration of blockers is illegal. If a creature can't block unless a player pays a cost, that player is not required to pay that cost, even if blocking with that creature would increase the number of requirements being obeyed. If a requirement that says a creature blocks if able during a certain turn refers to a turn with multiple combat phases, the creature blocks if able during each declare blockers step in that turn.
    Example: A player controls one creature that “blocks if able” and another creature with no abilities. If a creature with menace attacks that player, the player must block with both creatures. Having only the first creature block violates the restriction created by menace (the attacking creature can't be blocked except by two or more creatures). Having only the second creature block violates both the menace restriction and the first creature's blocking requirement. Having neither creature block fulfills the restriction but not the requirement.
509.1d If any of the chosen creatures require paying costs to block, the defending player determines the total cost to block. Costs may include paying mana, tapping permanents, sacrificing permanents, discarding cards, and so on. Once the total cost is determined, it becomes “locked in.” If effects would change the total cost after this time, ignore this change.
509.1e If any of the costs require mana, the defending player then has a chance to activate mana abilities (see rule 605, “Mana Abilities”).
509.1f Once the player has enough mana in their mana pool, they pay all costs in any order. Partial payments are not allowed.
509.1g Each chosen creature still controlled by the defending player becomes a blocking creature. Each one is blocking the attacking creatures chosen for it. It remains a blocking creature until it's removed from combat or the combat phase ends, whichever comes first. See rule 506.4.
509.1h An attacking creature with one or more creatures declared as blockers for it becomes a blocked creature; one with no creatures declared as blockers for it becomes an unblocked creature. This remains unchanged until the creature is removed from combat, an effect says that it becomes blocked or unblocked, or the combat phase ends, whichever comes first. A creature remains blocked even if all the creatures blocking it are removed from combat.
509.1i Any abilities that trigger on blockers being declared trigger. See rule 509.4 for more information.
509.2. Second, for each attacking creature that's become blocked, the active player announces that creature's damage assignment order, which consists of the creatures blocking it in an order of that player's choice. (During the combat damage step, an attacking creature can't assign combat damage to a creature that's blocking it unless each creature ahead of that blocking creature in its order is assigned lethal damage.) This turn-based action doesn't use the stack.
    Example: Vastwood Gorger is blocked by Llanowar Elves, Runeclaw Bear, and Serra Angel. Vastwood Gorger's controller announces the Vastwood Gorger's damage assignment order as Serra Angel, then Llanowar Elves, then Runeclaw Bear.
509.2a During the declare blockers step, if a blocking creature is removed from combat or a spell or ability causes it to stop blocking an attacking creature, the blocking creature is removed from all relevant damage assignment orders. The relative order among the remaining blocking creatures is unchanged.
509.3. Third, for each blocking creature, the defending player announces that creature's damage assignment order, which consists of the creatures it's blocking in an order of that player's choice. (During the combat damage step, a blocking creature can't assign combat damage to a creature it's blocking unless each creature ahead of that blocked creature in its order is assigned lethal damage.) This turn-based action doesn't use the stack.
509.3a During the declare blockers step, if an attacking creature is removed from combat or a spell or ability causes it to stop being blocked by a blocking creature, the attacking creature is removed from all relevant damage assignment orders. The relative order among the remaining attacking creatures is unchanged.
509.4. Fourth, the active player gets priority. (See rule 117, “Timing and Priority.”)
509.4a Any abilities that triggered on blockers being declared or that triggered during the process described in rules 509.1-3 are put onto the stack before the active player gets priority; the order in which they triggered doesn't matter. (See rule 603, “Handling Triggered Abilities.”)
509.5. Triggered abilities that trigger on blockers being declared may have different trigger conditions.
509.5a An ability that reads “Whenever [a creature] blocks, . . .” generally triggers only once each combat for that creature, even if it blocks multiple creatures. It triggers if the creature is declared as a blocker. It will also trigger if that creature becomes a blocker as the result of an effect, but only if it wasn't a blocking creature at that time. (See rule 509.1g.) It won't trigger if the creature is put onto the battlefield blocking.
509.5b An ability that reads “Whenever [a creature] blocks a creature, . . .” triggers once for each attacking creature the creature with the ability blocks. It triggers if the creature is declared as a blocker. It will also trigger if an effect causes that creature to block an attacking creature, but only if it wasn't already blocking that attacking creature at that time. It won't trigger if the creature is put onto the battlefield blocking.
509.5c An ability that reads “Whenever [a creature] becomes blocked, . . .” generally triggers only once each combat for that creature, even if it's blocked by multiple creatures. It will trigger if that creature becomes blocked by at least one creature declared as a blocker. It will also trigger if that creature becomes blocked by an effect or by a creature that's put onto the battlefield as a blocker, but only if the attacking creature was an unblocked creature at that time. (See rule 509.1h.)
509.5d An ability that reads “Whenever [a creature] becomes blocked by a creature, . . .” triggers once for each creature that blocks the specified creature. It triggers if a creature is declared as a blocker for the attacking creature. It will also trigger if an effect causes a creature to block the attacking creature, but only if it wasn't already blocking that attacking creature at that time. In addition, it will trigger if a creature is put onto the battlefield blocking that creature. It won't trigger if the creature becomes blocked by an effect rather than a creature.
509.5e If an ability triggers when a creature blocks or becomes blocked by a particular number of creatures, the ability triggers if the creature blocks or is blocked by that many creatures when blockers are declared. Effects that add or remove blockers can also cause such abilities to trigger. This applies to abilities that trigger on a creature blocking or being blocked by at least a certain number of creatures as well.
509.5f If an ability triggers when a creature with certain characteristics blocks, it will trigger only if the creature has those characteristics at the point blockers are declared, or at the point an effect causes it to block. If an ability triggers when a creature with certain characteristics becomes blocked, it will trigger only if the creature has those characteristics at the point it becomes a blocked creature. If an ability triggers when a creature becomes blocked by a creature with certain characteristics, it will trigger only if the latter creature has those characteristics at the point it becomes a blocking creature. None of those abilities will trigger if the relevant creature's characteristics change to match the ability's trigger condition later on.
    Example: A creature has the ability “Whenever this creature becomes blocked by a white creature, destroy that creature at end of combat.” If the creature becomes blocked by a black creature that is later turned white, the ability will not trigger.
509.5g An ability that reads “Whenever [a creature] attacks and isn't blocked, . . .” triggers if no creatures are declared as blockers for that creature. It will trigger even if the creature was never declared as an attacker (for example, if it entered the battlefield attacking). It won't trigger if the attacking creature is blocked and then all its blockers are removed from combat.
509.6. If a spell or ability causes a creature on the battlefield to block an attacking creature, the active player announces the blocking creature's placement in the attacking creature's damage assignment order. The relative order among the remaining blocking creatures is unchanged. Then the defending player announces the attacking creature's placement in the blocking creature's damage assignment order. The relative order among the remaining attacking creatures is unchanged. This is done as part of the blocking effect.
509.7. If a creature is put onto the battlefield blocking, its controller chooses which attacking creature it's blocking as it enters the battlefield (unless the effect that put it onto the battlefield specifies what it's blocking), then the active player announces the new creature's placement in the blocked creature's damage assignment order. The relative order among the remaining blocking creatures is unchanged. A creature put onto the battlefield this way is “blocking” but, for the purposes of trigger events and effects, it never “blocked.”
    Example: Giant Spider is blocked by Canyon Minotaur. The defending player casts Flash Foliage, which creates a Saproling creature token blocking the Giant Spider. Giant Spider's controller announces the Giant Spider's damage assignment order as the Saproling token, then Canyon Minotaur.
509.7a If the effect that puts a creature onto the battlefield blocking specifies it's blocking a certain creature and that creature is no longer attacking, the creature is put onto the battlefield but is never considered a blocking creature. The same is true if the controller of the creature that's put onto the battlefield blocking isn't a defending player for the specified attacking creature.
509.7b A creature that's put onto the battlefield blocking isn't affected by requirements or restrictions that apply to the declaration of blockers.
510. Combat Damage Step
510.1. First, the active player announces how each attacking creature assigns its combat damage, then the defending player announces how each blocking creature assigns its combat damage. This turn-based action doesn't use the stack. A player assigns a creature's combat damage according to the following rules:
510.1a Each attacking creature and each blocking creature assigns combat damage equal to its power. Creatures that would assign 0 or less damage this way don't assign combat damage at all.
510.1b An unblocked creature assigns its combat damage to the player, planeswalker, or battle it's attacking. If it isn't currently attacking anything (if, for example, it was attacking a planeswalker that has left the battlefield), it assigns no combat damage.
510.1c A blocked creature assigns its combat damage to the creatures blocking it. If no creatures are currently blocking it (if, for example, they were destroyed or removed from combat), it assigns no combat damage. If exactly one creature is blocking it, it assigns all its combat damage to that creature. If two or more creatures are blocking it, it assigns its combat damage to those creatures according to the damage assignment order announced for it. This may allow the blocked creature to divide its combat damage. However, it can't assign combat damage to a creature that's blocking it unless, when combat damage assignments are complete, each creature that precedes that blocking creature in its order is assigned lethal damage. When checking for assigned lethal damage, take into account damage already marked on the creature and damage from other creatures that's being assigned during the same combat damage step, but not any abilities or effects that might change the amount of damage that's actually dealt. An amount of damage that's greater than a creature's lethal damage may be assigned to it.
    Example: The damage assignment order of an attacking Vastwood Gorger (a 5/6 creature) is Pride Guardian (a 0/3 creature) then Llanowar Elves (a 1/1 creature). Vastwood Gorger can assign 3 damage to the Guardian and 2 damage to the Elves, 4 damage to the Guardian and 1 damage to the Elves, or 5 damage to the Guardian.
    Example: The damage assignment order of an attacking Vastwood Gorger (a 5/6 creature) is Pride Guardian (a 0/3 creature) then Llanowar Elves (a 1/1 creature). During the declare blockers step, the defending player casts Giant Growth targeting Pride Guardian, which gives it +3/+3 until end of turn. Vastwood Gorger must assign its 5 damage to the Guardian.
    Example: The damage assignment order of an attacking Vastwood Gorger (a 5/6 creature) is Pride Guardian (a 0/3 creature) then Llanowar Elves (a 1/1 creature). During the declare blockers step, the defending player casts Mending Hands targeting Pride Guardian, which prevents the next 4 damage that would be dealt to it. Vastwood Gorger can assign 3 damage to the Guardian and 2 damage to the Elves, 4 damage to the Guardian and 1 damage to the Elves, or 5 damage to the Guardian.
    Example: The damage assignment order of an attacking Enormous Baloth (a 7/7 creature) is Trained Armodon (a 3/3 creature) that already has 2 damage marked on it, then Foriysian Brigade (a 2/4 creature that can block an additional creature), then Silverback Ape (a 5/5 creature). The damage assignment order of an attacking Durkwood Boars (a 4/4 creature) is the same Foriysian Brigade, then Goblin Piker (a 2/1 creature). Among other possibilities, the active player may have the Baloth assign 1 damage to the Armodon, 1 damage to the Brigade, and 5 damage to the Ape, and have the Boars assign 3 damage to the Brigade and 1 damage to the Piker.
510.1d A blocking creature assigns combat damage to the creatures it's blocking. If it isn't currently blocking any creatures (if, for example, they were destroyed or removed from combat), it assigns no combat damage. If it's blocking exactly one creature, it assigns all its combat damage to that creature. If it's blocking two or more creatures, it assigns its combat damage to those creatures according to the damage assignment order announced for it. This may allow the blocking creature to divide its combat damage. However, it can't assign combat damage to a creature that it's blocking unless, when combat damage assignments are complete, each creature that precedes that blocked creature is assigned lethal damage. When checking for assigned lethal damage, take into account damage already marked on the creature and damage from other creatures that's being assigned during the same combat damage step, but not any abilities or effects that might change the amount of damage that's actually dealt. An amount of damage that's greater than a creature's lethal damage may be assigned to it.
510.1e Once a player has assigned combat damage from each attacking or blocking creature they control, the total damage assignment (not solely the damage assignment of any individual attacking or blocking creature) is checked to see if it complies with the above rules. If it doesn't, the combat damage assignment is illegal; the game returns to the moment before that player began to assign combat damage. (See rule 730, “Handling Illegal Actions.”)
510.2. Second, all combat damage that's been assigned is dealt simultaneously. This turn-based action doesn't use the stack. No player has the chance to cast spells or activate abilities between the time combat damage is assigned and the time it's dealt.
    Example: Squadron Hawk (a 1/1 creature with flying) and Goblin Piker (a 2/1 creature) are attacking. Mogg Fanatic (a 1/1 creature with the ability “Sacrifice Mogg Fanatic: Mogg Fanatic deals 1 damage to any target.”) blocks the Goblin Piker. The defending player sacrifices Mogg Fanatic during the declare blockers step to deal 1 damage to the Squadron Hawk. The Hawk is destroyed. The Piker deals and is dealt no combat damage this turn. If the defending player instead left Mogg Fanatic on the battlefield, the Fanatic and the Piker would have dealt lethal damage to one another, but the Squadron Hawk couldn't have been dealt damage.
510.3. Third, the active player gets priority. (See rule 117, “Timing and Priority.”)
510.3a Any abilities that triggered on damage being dealt or while state-based actions are performed afterward are put onto the stack before the active player gets priority; the order in which they triggered doesn't matter. (See rule 603, “Handling Triggered Abilities.”)
510.4. If at least one attacking or blocking creature has first strike (see rule 702.7) or double strike (see rule 702.4) as the combat damage step begins, the only creatures that assign combat damage in that step are those with first strike or double strike. After that step, instead of proceeding to the end of combat step, the phase gets a second combat damage step. The only creatures that assign combat damage in that step are the remaining attackers and blockers that had neither first strike nor double strike as the first combat damage step began, as well as the remaining attackers and blockers that currently have double strike. After that step, the phase proceeds to the end of combat step.

511. End of Combat Step
511.1. The end of combat step has no turn-based actions. Once it begins, the active player gets priority. (See rule 117, “Timing and Priority.”)
511.2. Abilities that trigger “at end of combat” trigger as the end of combat step begins. Effects that last “until end of combat” expire at the end of the combat phase.
511.3. As soon as the end of combat step ends, all creatures, battles, and planeswalkers are removed from combat. After the end of combat step ends, the combat phase is over and the postcombat main phase begins (see rule 505).

512. Ending Phase
512.1. The ending phase consists of two steps: end and cleanup.

513. End Step
513.1. The end step has no turn-based actions. Once it begins, the active player gets priority. (See rule 117, “Timing and Priority.”)
513.1a Previously, abilities that triggered at the beginning of the end step were printed with the trigger condition “at end of turn.” Cards that were printed with that text have received errata in the Oracle card reference to say “at the beginning of the end step” or “at the beginning of the next end step.”
513.2. If a permanent with an ability that triggers “at the beginning of the end step” enters the battlefield during this step, that ability won't trigger until the next turn's end step. Likewise, if a delayed triggered ability that triggers “at the beginning of the next end step” is created during this step, that ability won't trigger until the next turn's end step. In other words, the step doesn't “back up” so those abilities can go on the stack. This rule applies only to triggered abilities; it doesn't apply to continuous effects whose durations say “until end of turn” or “this turn.” (See rule 514, “Cleanup Step.”)

514. Cleanup Step
514.1. First, if the active player's hand contains more cards than their maximum hand size (normally seven), they discard enough cards to reduce their hand size to that number. This turn-based action doesn't use the stack.
514.2. Second, the following actions happen simultaneously: all damage marked on permanents (including phased-out permanents) is removed and all “until end of turn” and “this turn” effects end. This turn-based action doesn't use the stack.
514.3. Normally, no player receives priority during the cleanup step, so no spells can be cast and no abilities can be activated. However, this rule is subject to the following exception:
514.3a At this point, the game checks to see if any state-based actions would be performed and/or any triggered abilities are waiting to be put onto the stack (including those that trigger “at the beginning of the next cleanup step”). If so, those state-based actions are performed, then those triggered abilities are put on the stack, then the active player gets priority. Players may cast spells and activate abilities. Once the stack is empty and all players pass in succession, another cleanup step begins.

600. General

601. Casting Spells
601.1. Previously, the action of casting a spell, or casting a card as a spell, was referred to on cards as “playing” that spell or that card. Cards that were printed with that text have received errata in the Oracle card reference so they now refer to “casting” that spell or that card.
601.1a Some effects still refer to “playing” a card. “Playing a card” means playing that card as a land or casting that card as a spell, whichever is appropriate.
601.2. To cast a spell is to take it from where it is (usually the hand), put it on the stack, and pay its costs, so that it will eventually resolve and have its effect. Casting a spell includes proposal of the spell (rules 601.2a-d) and determination and payment of costs (rules 601.2f-h). To cast a spell, a player follows the steps listed below, in order. A player must be legally allowed to cast the spell to begin this process (see rule 601.3). If a player is unable to comply with the requirements of a step listed below while performing that step, the casting of the spell is illegal; the game returns to the moment before the casting of that spell was proposed (see rule 730, “Handling Illegal Actions”).
601.2a To propose the casting of a spell, a player first moves that card (or that copy of a card) from where it is to the stack. It becomes the topmost object on the stack. It has all the characteristics of the card (or the copy of a card) associated with it, and that player becomes its controller. Any continuous effects that modify the characteristics of the spell as you start casting it begin as it is put on the stack (see rule 611.2f). The spell remains on the stack until it resolves, it's countered, or a rule or effect moves it elsewhere.
601.2b If the spell is modal, the player announces the mode choice (see rule 700.2). If the player wishes to splice any cards onto the spell (see rule 702.47), they reveal those cards in their hand. If the spell has alternative or additional costs that will be paid as it's being cast such as buyback or kicker costs (see rules 118.8 and 118.9), the player announces their intentions to pay any or all of those costs (see rule 601.2f). A player can't apply two alternative methods of casting or two alternative costs to a single spell. If the spell has a variable cost that will be paid as it's being cast (such as an {X} in its mana cost; see rule 107.3), the player announces the value of that variable. If the value of that variable is defined in the text of the spell by a choice that player would make later in the announcement or resolution of the spell, that player makes that choice at this time instead of that later time. If a cost that will be paid as the spell is being cast includes hybrid mana symbols, the player announces the nonhybrid equivalent cost they intend to pay. If a cost that will be paid as the spell is being cast includes Phyrexian mana symbols, the player announces whether they intend to pay 2 life or a corresponding colored mana cost for each of those symbols. Previously made choices (such as choosing to cast a spell with flashback from a graveyard or choosing to cast a creature with morph face down) may restrict the player's options when making these choices.
601.2c The player announces their choice of an appropriate object or player for each target the spell requires. A spell may require some targets only if an alternative or additional cost (such as a kicker cost) or a particular mode was chosen for it; otherwise, the spell is cast as though it did not require those targets. Similarly, a spell may require alternative targets only if an alternative or additional cost was chosen for it. If the spell has a variable number of targets, the player announces how many targets they will choose before they announce those targets. In some cases, the number of targets will be defined by the spell's text. Once the number of targets the spell has is determined, that number doesn't change, even if the information used to determine the number of targets does. The same target can't be chosen multiple times for any one instance of the word “target” on the spell. However, if the spell uses the word “target” in multiple places, the same object or player can be chosen once for each instance of the word “target” (as long as it fits the targeting criteria). If any effects say that an object or player must be chosen as a target, the player chooses targets so that they obey the maximum possible number of such effects without violating any rules or effects that say that an object or player can't be chosen as a target. The chosen objects and/or players each become a target of that spell. (Any abilities that trigger when those objects and/or players become the target of a spell trigger at this point; they'll wait to be put on the stack until the spell has finished being cast.)
    Example: If a spell says “Tap two target creatures,” then the same creature can't be chosen twice; the spell requires two different legal targets. A spell that says “Destroy target artifact and target land,” however, can target the same artifact land twice because it uses the word “target” in multiple places.
601.2d If the spell requires the player to divide or distribute an effect (such as damage or counters) among one or more targets, the player announces the division. Each of these targets must receive at least one of whatever is being divided.
601.2e The game checks to see if the proposed spell can legally be cast. If the proposed spell is illegal, the game returns to the moment before the casting of that spell was proposed (see rule 730, “Handling Illegal Actions”).
601.2f The player determines the total cost of the spell. Usually this is just the mana cost. Some spells have additional or alternative costs. Some effects may increase or reduce the cost to pay, or may provide other alternative costs. Costs may include paying mana, tapping permanents, sacrificing permanents, discarding cards, and so on. The total cost is the mana cost or alternative cost (as determined in rule 601.2b), plus all additional costs and cost increases, and minus all cost reductions. If multiple cost reductions apply, the player may apply them in any order. If the mana component of the total cost is reduced to nothing by cost reduction effects, it is considered to be {0}. It can't be reduced to less than {0}. Once the total cost is determined, any effects that directly affect the total cost are applied. Then the resulting total cost becomes “locked in.” If effects would change the total cost after this time, they have no effect.
601.2g If the total cost includes a mana payment, the player then has a chance to activate mana abilities (see rule 605, “Mana Abilities”). Mana abilities must be activated before costs are paid.
601.2h The player pays the total cost. First, they pay all costs that don't involve random elements or moving objects from the library to a public zone, in any order. Then they pay all remaining costs in any order. Partial payments are not allowed. Unpayable costs can't be paid.
    Example: You cast Altar's Reap, which costs {1}{B} and has an additional cost of sacrificing a creature. You sacrifice Thunderscape Familiar, whose effect makes your black spells cost {1} less to cast. Because a spell's total cost is “locked in” before payments are actually made, you pay {B}, not {1}{B}, even though you're sacrificing the Familiar.
601.2i Once the steps described in 601.2a-h are completed, effects that modify the characteristics of the spell as it's cast are applied, then the spell becomes cast. Any abilities that trigger when a spell is cast or put onto the stack trigger at this time. If the spell's controller had priority before casting it, they get priority.
601.3. A player can begin to cast a spell only if a rule or effect allows that player to cast it and no rule or effect prohibits that player from casting it.
601.3a If an effect prohibits a player from casting a spell with certain qualities, that player may consider any choices to be made during that spell's proposal that may cause those qualities to change. If any such choices could cause that effect to no longer prohibit that player from casting that spell, the player may begin to cast the spell, ignoring the effect.
    Example: A player controls Void Winnower, which reads, in part, “Your opponents can't cast spells with even mana values.” That player's opponent may begin to cast Rolling Thunder, a card whose mana cost is {X}{R}{R}, because the chosen value of X may cause the spell's mana value to become odd.
601.3b If an effect allows a player to cast a spell with certain qualities as though it had flash, that player may consider any choices to be made during that spell's proposal that may cause that spell's qualities to change. If any such choices could cause that effect to apply, that player may begin to cast that spell as though it had flash.
    Example: An effect says that you may cast Aura spells as though they had flash, and you have a creature card with bestow in your hand. Because choosing the bestow ability's alternative cost causes that spell to become an Aura spell, you may legally begin to cast that spell as though it had flash.
601.3c If an effect allows a player to cast a spell as though it had flash only if an alternative or additional cost is paid, that player may begin to cast that spell as though it had flash.
601.3d If a spell would have flash only if certain conditions are met, its controller may begin to cast that spell as though it had flash if those conditions are met.
601.3e Some rules and effects state that an alternative set of characteristics or a subset of characteristics are considered to determine if a card or copy of a card is legal to cast. These alternative characteristics replace the object's characteristics for this determination. Continuous effects that would apply to that object once it has those characteristics are also considered.
    Example: Garruk's Horde says, in part, “You may cast creature spells from the top of your library.” If you control Garruk's Horde and the top card of your library is a noncreature card with morph, you may cast it using its morph ability.
    Example: Melek, Izzet Paragon says, in part, “You may cast instant and sorcery spells from the top of your library.” If you control Melek, Izzet Paragon and the top card of your library is Giant Killer, an adventurer creature card whose Adventure is an instant named Chop Down, you may cast Chop Down but not Giant Killer. If instead you control Garruk's Horde and the top card of your library is Giant Killer, you may cast Giant Killer but not Chop Down.
601.3f Some effects allow a player to cast a spell with certain qualities from among face-down cards in exile. A player may begin to cast such a spell only if they can look at the face-down card in exile.
601.4. While announcing the choices of any modes, alternative costs, and/or additional costs as described in rule 601.2b, some options may be available to a player only if other choices are made that would normally be made later in that rule's instructions. In that case, the spell's controller may consider any other choices to be made in that step. If any such choices could allow them to choose a particular mode, alternative cost, or additional cost, they may do so.
    Example: Inscription of Abundance is a modal spell with kicker and the text “Choose one. If this spell was kicked, choose any number instead.” When announcing the chosen modes for the spell, its controller may choose any number of modes, even though choosing to pay the kicker cost is normally done later in the announcement process.
601.5. If a player is no longer allowed to cast a spell after completing its proposal (see rules 601.2a-d), the casting of the spell is illegal and the game returns to the moment before the casting of that spell was proposed (see rule 730, “Handling Illegal Actions”). It doesn't matter if a rule or effect would make the casting of the spell illegal while determining and paying that spell's costs (see rules 601.2f-h) or any time after the spell has been cast.
601.5a Once a player has begun casting a spell that had flash because certain conditions were met or that could be cast as though it had flash because certain conditions were met (see 601.3d), they may continue to cast that spell as though it had flash even if those conditions stop being met.
601.6. Some spells specify that one of their controller's opponents does something the controller would normally do while it's being cast, such as choose a mode or choose targets. In these cases, the opponent does so when the spell's controller normally would do so.
601.6a If there is more than one opponent who could make such a choice, the spell's controller decides which of those opponents will make the choice.
601.6b If the spell instructs its controller and another player to do something at the same time as the spell is being cast, the spell's controller goes first, then the other player. This is an exception to rule 101.4.
601.7. Casting a spell that alters costs won't affect spells and abilities that are already on the stack.

602. Activating Activated Abilities
602.1. Activated abilities have a cost and an effect. They are written as “[Cost]: [Effect.] [Activation instructions (if any).]”
602.1a The activation cost is everything before the colon (:). An ability's activation cost must be paid by the player who is activating it.
    Example: The activation cost of an ability that reads “{2}, {T}: You gain 1 life” is two mana of any type plus tapping the permanent that has the ability.
602.1b Some text after the colon of an activated ability states instructions that must be followed while activating that ability. Such text may state which players can activate that ability, may restrict when a player can activate the ability, or may define some aspect of the activation cost. This text is not part of the ability's effect. It functions at all times. If an activated ability has any activation instructions, they appear last, after the ability's effect.
602.1c An activated ability is the only kind of ability that can be activated. If an object or rule refers to activating an ability without specifying what kind, it must be referring to an activated ability.
602.1d Previously, the action of using an activated ability was referred to on cards as “playing” that ability. Cards that were printed with that text have received errata in the Oracle card reference so they now refer to “activating” that ability.
602.1e If a spell or ability that refers to the “activation cost” of an ability modifies how a player may pay that cost, that modification applies to the total cost of that ability, even if that cost is increased and/or decreased by other effects. See rules 602.2b and 601.2f.
602.2. To activate an ability is to put it onto the stack and pay its costs, so that it will eventually resolve and have its effect. Only an object's controller (or its owner, if it doesn't have a controller) can activate its activated ability unless the object specifically says otherwise. Activating an ability follows the steps listed below, in order. If, at any point during the activation of an ability, a player is unable to comply with any of those steps, the activation is illegal; the game returns to the moment before that ability started to be activated (see rule 730, “Handling Illegal Actions”). Announcements and payments can't be altered after they've been made.
602.2a The player announces that they are activating the ability. If an activated ability is being activated from a hidden zone, the card that has that ability is revealed (see rule 701.16a). That ability is created on the stack as an object that's not a card. It becomes the topmost object on the stack. It has the text of the ability that created it, and no other characteristics. Its controller is the player who activated the ability. The ability remains on the stack until it's countered, it resolves, or an effect moves it elsewhere.
602.2b The remainder of the process for activating an ability is identical to the process for casting a spell listed in rules 601.2b-i. Those rules apply to activating an ability just as they apply to casting a spell. An activated ability's analog to a spell's mana cost (as referenced in rule 601.2f) is its activation cost.
602.3. Some abilities specify that one of their controller's opponents does something the controller would normally do while it's being activated, such as choose a mode or choose targets. In these cases, the opponent does so when the ability's controller normally would do so.
602.3a If there is more than one opponent who could make such a choice, the ability's controller decides which of those opponents will make the choice.
602.3b If the ability instructs its controller and another player to do something at the same time as the ability is being activated, the ability's controller goes first, then the other player. This is an exception to rule 101.4.
602.4. Activating an ability that alters costs won't affect spells and abilities that are already on the stack.
602.5. A player can't begin to activate an ability that's prohibited from being activated.
602.5a A creature's activated ability with the tap symbol ({T}) or the untap symbol ({Q}) in its activation cost can't be activated unless the creature has been under its controller's control since the start of their most recent turn. Ignore this rule for creatures with haste (see rule 702.10).
602.5b If an activated ability has a restriction on its use (for example, “Activate only once each turn”), the restriction continues to apply to that object even if its controller changes.
602.5c If an object acquires an activated ability with a restriction on its use from another object, that restriction applies only to that ability as acquired from that object. It doesn't apply to other, identically worded abilities.
602.5d Activated abilities that read “Activate only as a sorcery” mean the player must follow the timing rules for casting a sorcery spell, though the ability isn't actually a sorcery. The player doesn't actually need to have a sorcery card that they could cast.
602.5e Activated abilities that read “Activate only as an instant” mean the player must follow the timing rules for casting an instant spell, though the ability isn't actually an instant. The player doesn't actually need to have an instant card that they could cast.

603. Handling Triggered Abilities
603.1. Triggered abilities have a trigger condition and an effect. They are written as “[When/Whenever/At] [trigger condition or event], [effect]. [Instructions (if any).]”
603.1a A triggered ability may include instructions after its effects that limit what the ability may target or state that it can't be countered. This text is not part of the ability's effect. It functions while the ability is on the stack.
603.2. Whenever a game event or game state matches a triggered ability's trigger event, that ability automatically triggers. The ability doesn't do anything at this point.
603.2a Because they aren't cast or activated, triggered abilities can trigger even when it isn't legal to cast spells and activate abilities. Effects that preclude abilities from being activated don't affect them.
603.2b When a phase or step begins, all abilities that trigger “at the beginning of” that phase or step trigger.
603.2c An ability triggers only once each time its trigger event occurs. However, it can trigger repeatedly if one event contains multiple occurrences.
Example: A permanent has an ability whose trigger condition reads, “Whenever a land is put into a graveyard from the battlefield, . . . .” If someone casts a spell that destroys all lands, the ability will trigger once for each land put into the graveyard during the spell's resolution.
603.2d An ability may state that a triggered ability triggers additional times. In this case, rather than simply determining that such an ability has triggered, determine how many times it should trigger, then that ability triggers that many times. An effect that states that an ability triggers additional times doesn't invoke itself repeatedly and doesn't apply to other effects that affect how many times an ability triggers.
603.2e Some effects refer to a triggered ability of an object. Such effects refer only to triggered abilities the object has, not any delayed triggered abilities (see rule 603.7) that may be created by abilities the object has.
603.2f Some trigger events use the word “becomes” (for example, “becomes attached” or “becomes blocked”). These trigger only at the time the named event happens—they don't trigger if that state already exists or retrigger if it persists. An ability that triggers when a permanent “becomes tapped” or “becomes untapped” doesn't trigger if the permanent enters the battlefield in that state.
    Example: An ability that triggers when a permanent “becomes tapped” triggers only when the status of a permanent that's already on the battlefield changes from untapped to tapped.
603.2g If a triggered ability's trigger condition is met, but the object with that triggered ability is at no time visible to all players, the ability does not trigger.
603.2h An ability triggers only if its trigger event actually occurs. An event that's prevented or replaced won't trigger anything.
    Example: An ability that triggers on damage being dealt won't trigger if all the damage is prevented.
603.2i A triggered ability may have an instruction followed by “Do this only once each turn.” This ability triggers only if its source's controller has not yet taken the indicated action that turn.
603.3. Once an ability has triggered, its controller puts it on the stack as an object that's not a card the next time a player would receive priority. See rule 117, “Timing and Priority.” The ability becomes the topmost object on the stack. It has the text of the ability that created it, and no other characteristics. It remains on the stack until it's countered, it resolves, a rule causes it to be removed from the stack, or an effect moves it elsewhere.
603.3a A triggered ability is controlled by the player who controlled its source at the time it triggered, unless it's a delayed triggered ability. To determine the controller of a delayed triggered ability, see rules 603.7d-f.
603.3b If multiple abilities have triggered since the last time a player received priority, the abilities are placed on the stack in a two-part process. First, each player, in APNAP order, puts each triggered ability they control with a trigger condition that isn't another ability triggering on the stack in any order they choose. (See rule 101.4.) Second, each player, in APNAP order, puts all remaining triggered abilities they control on the stack in any order they choose. Then the game once again checks for and performs state-based actions until none are performed, then abilities that triggered during this process go on the stack. This process repeats until no new state-based actions are performed and no abilities trigger. Then the appropriate player gets priority.
603.3c If a triggered ability is modal, its controller announces the mode choice when putting the ability on the stack. If one of the modes would be illegal (due to an inability to choose legal targets, for example), that mode can't be chosen. If no mode is chosen, the ability is removed from the stack. (See rule 700.2.)
603.3d The remainder of the process for putting a triggered ability on the stack is identical to the process for casting a spell listed in rules 601.2c-d. If a choice is required when the triggered ability goes on the stack but no legal choices can be made for it, or if a rule or a continuous effect otherwise makes the ability illegal, the ability is simply removed from the stack.
603.4. A triggered ability may read “When/Whenever/At [trigger event], if [condition], [effect].” When the trigger event occurs, the ability checks whether the stated condition is true. The ability triggers only if it is; otherwise it does nothing. If the ability triggers, it checks the stated condition again as it resolves. If the condition isn't true at that time, the ability is removed from the stack and does nothing. Note that this mirrors the check for legal targets. This rule is referred to as the “intervening ‘if' clause” rule. (The word “if” has only its normal English meaning anywhere else in the text of a card; this rule only applies to an “if” that immediately follows a trigger condition.)
    Example: Felidar Sovereign reads, “At the beginning of your upkeep, if you have 40 or more life, you win the game.” Its controller's life total is checked as that player's upkeep begins. If that player has 39 or less life, the ability doesn't trigger at all. If that player has 40 or more life, the ability triggers and goes on the stack. As the ability resolves, that player's life total is checked again. If that player has 39 or less life at this time, the ability is removed from the stack and has no effect. If that player has 40 or more life at this time, the ability resolves and that player wins the game.
603.5. Some triggered abilities' effects are optional (they contain “may,” as in “At the beginning of your upkeep, you may draw a card”). These abilities go on the stack when they trigger, regardless of whether their controller intends to exercise the ability's option or not. The choice is made when the ability resolves. Likewise, triggered abilities that have an effect “unless” something is true or a player chooses to do something will go on the stack normally; the “unless” part of the ability is dealt with when the ability resolves.
603.6. Trigger events that involve objects changing zones are called “zone-change triggers.” Many abilities with zone-change triggers attempt to do something to that object after it changes zones. During resolution, these abilities look for the object in the zone that it moved to. If the object is unable to be found in the zone it went to, the part of the ability attempting to do something to the object will fail to do anything. The ability could be unable to find the object because the object never entered the specified zone, because it left the zone before the ability resolved, or because it is in a zone that is hidden from a player, such as a library or an opponent's hand. (This rule applies even if the object leaves the zone and returns again before the ability resolves.) The most common zone-change triggers are enters-the-battlefield triggers and leaves-the-battlefield triggers.
603.6a Enters-the-battlefield abilities trigger when a permanent enters the battlefield. These are written, “When [this object] enters, . . . “ or “Whenever a [type] enters, . . .” Each time an event puts one or more permanents onto the battlefield, all permanents on the battlefield (including the newcomers) are checked for any enters-the-battlefield triggers that match the event.
603.6b Continuous effects that modify characteristics of a permanent do so the moment the permanent is on the battlefield (and not before then). The permanent is never on the battlefield with its unmodified characteristics. Continuous effects don't apply before the permanent is on the battlefield, however (see rule 603.6d).
    Example: If an effect reads “All lands are creatures” and a land card is played, the effect makes the land card into a creature the moment it enters the battlefield, so it would trigger abilities that trigger when a creature enters the battlefield. Conversely, if an effect reads “All creatures lose all abilities” and a creature card with an enters-the-battlefield triggered ability enters the battlefield, that effect will cause it to lose its abilities the moment it enters the battlefield, so the enters-the-battlefield ability won't trigger.
603.6c Leaves-the-battlefield abilities trigger when a permanent moves from the battlefield to another zone, or when a phased-in permanent leaves the game because its owner leaves the game. These are written as, but aren't limited to, “When [this object] leaves the battlefield, . . .” or “Whenever [something] is put into a graveyard from the battlefield, . . . .” (See also rule 603.10.) An ability that attempts to do something to the card that left the battlefield checks for it only in the first zone that it went to. An ability that triggers when a card is put into a certain zone “from anywhere” is never treated as a leaves-the-battlefield ability, even if an object is put into that zone from the battlefield.
603.6d Some permanents have text that reads “[This permanent] enters with . . . ,” “As [this permanent] enters . . . ,” “[This permanent] enters as . . . ,” or “[This permanent] enters tapped.” Such text is a static ability—not a triggered ability—whose effect occurs as part of the event that puts the permanent onto the battlefield.
603.6e Some Auras have triggered abilities that trigger on the enchanted permanent leaving the battlefield. These triggered abilities can find the new object that permanent card became in the zone it moved to; they can also find the new object the Aura card became in its owner's graveyard after state-based actions have been checked. See rule 400.7.
603.7. An effect may create a delayed triggered ability that can do something at a later time. A delayed triggered ability will contain “when,” “whenever,” or “at,” although that word won't usually begin the ability.
603.7a Delayed triggered abilities are created during the resolution of spells or abilities, as the result of a replacement effect being applied, or as a result of a static ability that allows a player to take an action. A delayed triggered ability won't trigger until it has actually been created, even if its trigger event occurred just beforehand. Other events that happen earlier may make the trigger event impossible.
    Example: Part of an effect reads “When this creature leaves the battlefield,” but the creature in question leaves the battlefield before the spell or ability creating the effect resolves. In this case, the delayed ability never triggers.
    Example: If an effect reads “When this creature becomes untapped” and the named creature becomes untapped before the effect resolves, the ability waits for the next time that creature untaps.
603.7b A delayed triggered ability will trigger only once—the next time its trigger event occurs—unless it has a stated duration, such as “this turn.” If its trigger event occurs more than once simultaneously and the ability doesn't have a stated duration, the controller of the delayed triggered ability chooses which event causes the ability to trigger.
603.7c A delayed triggered ability that refers to a particular object still affects it even if the object changes characteristics. However, if that object is no longer in the zone it's expected to be in at the time the delayed triggered ability resolves, the ability won't affect it. (Note that if that object left that zone and then returned, it's a new object and thus won't be affected. See rule 400.7.)
    Example: An ability that reads “Exile this creature at the beginning of the next end step” will exile the permanent even if it's no longer a creature during the next end step. However, it won't do anything if the permanent left the battlefield before then.
603.7d If a spell creates a delayed triggered ability, the source of that delayed triggered ability is that spell. The controller of that delayed triggered ability is the player who controlled that spell as it resolved.
603.7e If an activated or triggered ability creates a delayed triggered ability, the source of that delayed triggered ability is the same as the source of that other ability. The controller of that delayed triggered ability is the player who controlled that other ability as it resolved.
603.7f If a static ability generates a replacement effect which causes a delayed triggered ability to be created, the source of that delayed triggered ability is the object with that static ability. The controller of that delayed triggered ability is the same as the controller of that object at the time the replacement effect was applied.
603.7g If a static ability allows a player to take an action and creates a delayed triggered ability if that player does so, the source of that delayed triggered ability is the object with that static ability. The controller of that delayed triggered ability is the same as the controller of that object at the time the action was taken.
603.7h An activated or triggered ability may create a delayed triggered ability that triggers when the ability that created it has resolved a certain number of times in a turn. In that case, that delayed triggered ability is created only once, during the appropriate resolution of that ability.
603.8. Some triggered abilities trigger when a game state (such as a player controlling no permanents of a particular card type) is true, rather than triggering when an event occurs. These abilities trigger as soon as the game state matches the condition. They'll go onto the stack at the next available opportunity. These are called state triggers. (Note that state triggers aren't the same as state-based actions.) A state-triggered ability doesn't trigger again until the ability has resolved, has been countered, or has otherwise left the stack. Then, if the object with the ability is still in the same zone and the game state still matches its trigger condition, the ability will trigger again.
    Example: A permanent's ability reads, “Whenever you have no cards in hand, draw a card.” If its controller plays the last card from their hand, the ability will trigger once and won't trigger again until it has left the stack. If its controller casts a spell that reads “Discard your hand, then draw that many cards,” the ability will trigger during the spell's resolution because the player's hand was momentarily empty.
603.9. Some triggered abilities trigger specifically when a player loses the game. These abilities trigger when a player loses or leaves the game, regardless of the reason, unless that player leaves the game as the result of a draw. See rule 104.3.
603.10. Normally, objects that exist immediately after an event are checked to see if the event matched any trigger conditions, and continuous effects that exist at that time are used to determine what the trigger conditions are and what the objects involved in the event look like. However, some triggered abilities are exceptions to this rule; the game “looks back in time” to determine if those abilities trigger, using the existence of those abilities and the appearance of objects immediately prior to the event. The list of exceptions is as follows:
603.10a Some zone-change triggers look back in time. These are leaves-the-battlefield abilities, abilities that trigger when a card leaves a graveyard, and abilities that trigger when an object that all players can see is put into a hand or library.
    Example: Two creatures are on the battlefield along with an artifact that has the ability “Whenever a creature dies, you gain 1 life.” Someone casts a spell that destroys all artifacts, creatures, and enchantments. The artifact's ability triggers twice, even though the artifact goes to its owner's graveyard at the same time as the creatures.
603.10b Abilities that trigger when a permanent phases out look back in time.
603.10c Abilities that trigger specifically when an object becomes unattached look back in time.
603.10d Abilities that trigger when a player loses control of an object look back in time.
603.10e Abilities that trigger when a spell is countered look back in time.
603.10f Abilities that trigger when a player loses the game look back in time.
603.10g Abilities that trigger when a player planeswalks away from a plane look back in time.
603.11. Some objects have a static ability that's linked to one or more triggered abilities. (See rule 607, “Linked Abilities.”) These objects combine the abilities into one paragraph, with the static ability first, followed by each triggered ability that's linked to it. A very few objects have triggered abilities which are written with the trigger condition in the middle of the ability, rather than at the beginning.
    Example: An ability that reads “Reveal the first card you draw each turn. Whenever you reveal a basic land card this way, draw a card” is a static ability linked to a triggered ability.
603.12. A resolving spell or ability may allow or instruct a player to take an action and create a triggered ability that triggers “when [a player] [does or doesn't]” take that action or “when [something happens] this way.” These reflexive triggered abilities follow the rules for delayed triggered abilities (see rule 603.7), except that they're checked immediately after being created and trigger based on whether the trigger event or events occurred earlier during the resolution of the spell or ability that created them.
    Example: Heart-Piercer Manticore has an ability that reads “When Heart-Piercer Manticore enters, you may sacrifice another creature. When you do, Heart-Piercer Manticore deals damage equal to that creature's power to any target.” The reflexive triggered ability triggers only when you sacrifice another creature due to the original triggered ability, and not if you sacrifice a creature for any other reason.
603.12a Normally, if the trigger event or events occur multiple times during the resolution of the spell or ability that created it, the reflexive triggered ability will trigger once for each of those times. However, if a resolving spell or ability includes a choice to pay a cost “any number of times” and creates a triggered ability that triggers “when [a player] pays [that cost] one or more times,” paying that cost one or more times causes the reflexive triggered ability to trigger only once.

608. Resolving Spells and Abilities
608.1. Each time all players pass in succession, the spell or ability on top of the stack resolves. (See rule 609, “Effects.”)
608.2. If the object that's resolving is an instant spell, a sorcery spell, or an ability, its resolution may involve several steps. The steps described in rules 608.2a and 608.2b are followed first. The steps described in rules 608.2c-m are then followed as appropriate, in no specific order. The steps described in rule 608.2n and 608.2p are followed last.
608.2a If a triggered ability has an intervening “if” clause, it checks whether the clause's condition is true. If it isn't, the ability is removed from the stack and does nothing. Otherwise, it continues to resolve. See rule 603.4.
608.2b If the spell or ability specifies targets, it checks whether the targets are still legal. A target that's no longer in the zone it was in when it was targeted is illegal. Other changes to the game state may cause a target to no longer be legal; for example, its characteristics may have changed or an effect may have changed the text of the spell. If the source of an ability has left the zone it was in, its last known information is used during this process. If all its targets, for every instance of the word “target,” are now illegal, the spell or ability doesn't resolve. It's removed from the stack and, if it's a spell, put into its owner's graveyard. Otherwise, the spell or ability will resolve normally. Illegal targets, if any, won't be affected by parts of a resolving spell's effect for which they're illegal. Other parts of the effect for which those targets are not illegal may still affect them. If the spell or ability creates any continuous effects that affect game rules (see rule 613.11), those effects don't apply to illegal targets. If part of the effect requires information about an illegal target, it fails to determine any such information. Any part of the effect that requires that information won't happen.
    Example: Sorin's Thirst is a black instant that reads, “Sorin's Thirst deals 2 damage to target creature and you gain 2 life.” If the creature isn't a legal target during the resolution of Sorin's Thirst (say, if the creature has gained protection from black or left the battlefield), then Sorin's Thirst doesn't resolve. Its controller doesn't gain any life.
    Example: Plague Spores reads, “Destroy target nonblack creature and target land. They can't be regenerated.” Suppose the same creature land is chosen both as the nonblack creature and as the land, and the color of the creature land is changed to black before Plague Spores resolves. Plague Spores still resolves because the black creature land is still a legal target for the “target land” part of the spell. The “destroy target nonblack creature” part of the spell won't affect that permanent, but the “destroy target land” part of the spell will still destroy it. It can't be regenerated.
608.2c The controller of the spell or ability follows its instructions in the order written. However, replacement effects may modify these actions. In some cases, later text on the card may modify the meaning of earlier text (for example, “Destroy target creature. It can't be regenerated” or “Counter target spell. If that spell is countered this way, put it on top of its owner's library instead of into its owner's graveyard.”) Don't just apply effects step by step without thinking in these cases—read the whole text and apply the rules of English to the text.
608.2d If an effect of a spell or ability offers any choices other than choices already made as part of casting the spell, activating the ability, or otherwise putting the spell or ability on the stack, the player announces these while applying the effect. The player can't choose an option that's illegal or impossible, with the exception that having a library with no cards in it doesn't make drawing a card an impossible action (see rule 121.3). If an effect divides or distributes something, such as damage or counters, as a player chooses among any number of untargeted players and/or objects, the player chooses the amount and division such that each chosen player or object receives at least one of whatever is being divided. (Note that if an effect divides or distributes something, such as damage or counters, as a player chooses among some number of target objects and/or players, the amount and division were determined as the spell or ability was put onto the stack rather than at this time; see rule 601.2d.)
    Example: A spell's instruction reads, “You may sacrifice a creature. If you don't, you lose 4 life.” A player who controls no creatures can't choose the sacrifice option.
608.2e Some spells and abilities have multiple steps or actions, denoted by separate sentences or clauses, that involve multiple players. In these cases, the choices for the first action are made in APNAP order, and then the first action is processed simultaneously. Then the choices for the second action are made in APNAP order, and then that action is processed simultaneously, and so on. See rule 101.4.
608.2f Some spells and abilities include actions taken on multiple players and/or objects. In most cases, each such action is processed simultaneously. If the action can't be processed simultaneously, it's instead processed considering each affected player or object individually. APNAP order is used to make the primary determination of the order of those actions. Secondarily, if the action is to be taken on both a player and an object they control or on multiple objects controlled by the same player, the player who controls the resolving spell or ability chooses the relative order of those actions.
    Example: Blatant Thievery says “For each opponent, gain control of target permanent that player controls.” As Blatant Thievery resolves, its controller gains control of all permanents chosen as targets simultaneously.
Example: Soulfire Eruption says, in part, “Choose any number of target creatures, planeswalkers, and/or players. For each of them, exile the top card of your library, then Soulfire Eruption deals damage equal to that card's mana value to that permanent or player.” A player casts Soulfire Eruption targeting an opponent and a creature that opponent controls. As Soulfire Eruption resolves, the player can't exile the top card of their library multiple times at the same time, so they first choose which target they are considering, then they exile the top card of their library, and finally Soulfire Eruption deals damage to that target. They then repeat this process for the remaining target. 
608.2g If an effect gives a player the option to pay mana, they may activate mana abilities before taking that action. If an effect specifically instructs or allows a player to cast a spell during resolution, they do so by following the steps in rules 601.2a-i, except no player receives priority after it's cast. That spell becomes the topmost object on the stack, and the currently resolving spell or ability continues to resolve, which may include casting other spells this way. No other spells can normally be cast and no other abilities can normally be activated during resolution.
608.2h If an effect requires information from the game (such as the number of creatures on the battlefield), the answer is determined only once, when the effect is applied. If the effect requires information from a specific object, including the source of the ability itself, the effect uses the current information of that object if it's in the public zone it was expected to be in; if it's no longer in that zone, or if the effect has moved it from a public zone to a hidden zone, the effect uses the object's last known information. See rule 113.7a. If an ability states that an object does something, it's the object as it exists—or as it most recently existed—that does it, not the ability.
608.2i Some effects look back in time and require information about previous game states and actions rather than considering the current game state. If such an effect requires information from the game about an object or group of objects, and that effect is not taking any actions on those objects, they don't need to be currently in the zone they were in at the time of that previous game state or action, nor do they need to currently meet the criteria described in the action, as long as they did so at the specified time. This is an exception to 608.2h.
    Example: A player attacks with Bear Cub. Later in the turn, an effect causes Bear Cub to become a noncreature permanent. The same player then casts Search Party Captain, a spell that says in part “This spell costs {1} less to cast for each creature you attacked with this turn.” That spell costs {1} less because the player attacked with a creature, even though the Bear Cub they attacked with is no longer a creature.
608.2j If an effect refers to certain characteristics, it checks only for the value of the specified characteristics, regardless of any related ones an object may also have.
    Example: An effect that reads “Destroy all black creatures” destroys a white-and-black creature, but one that reads “Destroy all nonblack creatures” doesn't.
608.2k If an ability's effect refers to a specific untargeted object that has been previously referred to by that ability's cost or trigger condition, it still affects that object even if the object has changed characteristics.
    Example: Wall of Tears says “Whenever Wall of Tears blocks a creature, return that creature to its owner's hand at end of combat.” If Wall of Tears blocks a creature, then that creature ceases to be a creature before the triggered ability resolves, the permanent will still be returned to its owner's hand.
608.2m If an instant spell, sorcery spell, or ability that can legally resolve leaves the stack once it starts to resolve, it will continue to resolve fully.
608.2n As the final part of an instant or sorcery spell's resolution, the spell is put into its owner's graveyard. As the final part of an ability's resolution, the ability is removed from the stack and ceases to exist.
608.2p Once all possible steps described in 608.2c-n are completed, any abilities that trigger when that spell or ability resolves trigger.
608.3. If the object that's resolving is a permanent spell, its resolution may involve several steps. The instructions in rules 608.3a and b are always performed first. Then one of the steps in rule 608.3c-e is performed, if appropriate.
608.3a If the object that's resolving has no targets, it becomes a permanent and enters the battlefield under the control of the spell's controller.
608.3b If the object that's resolving has a target, it checks whether the target is still legal, as described in 608.2b. If a spell with an illegal target is a bestowed Aura spell (see rule 702.103e) or a mutating creature spell (see rule 702.140b), it becomes a creature spell and will resolve as described in rule 608.3a. Otherwise, the spell doesn't resolve. It is removed from the stack and put into its owner's graveyard.
608.3c If the object that's resolving is an Aura spell, it becomes a permanent and is put onto the battlefield under the control of the spell's controller attached to the player or object it was targeting.
608.3d If the object that's resolving is a mutating creature spell, the object representing that spell merges with the permanent it is targeting (see rule 727, “Merging with Permanents”).
608.3e If a permanent spell resolves but its controller can't put it onto the battlefield, that player puts it into its owner's graveyard.
    Example: Worms of the Earth has the ability “Lands can't enter the battlefield.” Clone says “You may have Clone enter as a copy of any creature on the battlefield.” If a player casts Clone and chooses to copy Dryad Arbor (a land creature) while Worms of the Earth is on the battlefield, Clone can't enter the battlefield from the stack. It's put into its owner's graveyard.
608.3f If the object that's resolving is a copy of a permanent spell, it will become a token permanent as it is put onto the battlefield in any of the steps above. A token put onto the battlefield this way is no longer a copy of a spell and is not “created” for the purposes of any rules or effects that refer to creating a token.
608.3g If the object that's resolving has a static ability that functions on the stack and creates a delayed triggered ability, that delayed triggered ability is created as that permanent is put onto the battlefield in any of the steps above. (See rules 702.109, “Dash,” and rule 702.152, “Blitz.”)

703. Turn-Based Actions
703.1. Turn-based actions are game actions that happen automatically when certain steps or phases begin, or when each step and phase ends. Turn-based actions don't use the stack.
703.1a Abilities that watch for a specified step or phase to begin are triggered abilities, not turn-based actions. (See rule 603, “Handling Triggered Abilities.”)
703.2. Turn-based actions are not controlled by any player.
703.3. Whenever a step or phase begins, if it's a step or phase that has any turn-based action associated with it, those turn-based actions are automatically dealt with first. This happens before state-based actions are checked, before triggered abilities are put on the stack, and before players receive priority.
703.4. The turn-based actions are as follows:
703.4a Immediately after the untap step begins, all phased-in permanents with phasing that the active player controls phase out, and all phased-out permanents that the active player controlled when they phased out phase in. This all happens simultaneously. See rule 502.1.
703.4b Immediately after the phasing action has been completed during the untap step, if the game has either the day or night designation, it checks to see whether that designation should change. If it's neither day nor night, this check doesn't happen. See rule 502.2.
703.4c Immediately after the game checks to see if its day or night designation should change during the untap step or, if the game doesn't have a day or night designation, immediately after the phasing action has been completed during the untap step, the active player determines which permanents they control will untap. Then they untap them all simultaneously. See rule 502.3.
703.4d Immediately after the draw step begins, the active player draws a card. See rule 504.1.
703.4e In an Archenemy game (see rule 904), immediately after the archenemy's precombat main phase begins, that player sets the top card of their scheme deck in motion. See rule 701.25.
703.4f Immediately after a player's precombat main phase begins, that player puts a lore counter on each Saga enchantment they control. In an Archenemy game, this happens after the archenemy's scheme action. See rule 714, “Saga Cards.”
703.4g Immediately after the action of placing lore counters has been completed, if the active player controls any Attractions, that player rolls to visit their Attractions. See rule 701.49, “Roll to Visit Your Attractions.”
703.4h Immediately after the beginning of combat step begins, if the game being played is a multiplayer game in which the active player's opponents don't all automatically become defending players, the active player chooses one of their opponents. That player becomes the defending player. See rule 507.1.
703.4i Immediately after the declare attackers step begins, the active player declares attackers. See rule 508.1.
703.4j Immediately after the declare blockers step begins, the defending player declares blockers. See rule 509.1.
703.4k Immediately after blockers have been declared during the declare blockers step, for each attacking creature that's become blocked by multiple creatures, the active player announces the damage assignment order among the blocking creatures. See rule 509.2.
703.4m Immediately after the active player has announced damage assignment orders (if necessary) during the declare blockers step, for each creature that's blocking multiple creatures, the defending player announces the damage assignment order among the attacking creatures. See rule 509.3.
703.4n Immediately after the combat damage step begins, each player in APNAP order announces how each attacking or blocking creature they control assigns its combat damage. See rule 510.1.
703.4p Immediately after combat damage has been assigned during the combat damage step, all combat damage is dealt simultaneously. See rule 510.2.
703.4q Immediately after the cleanup step begins, if the active player's hand contains more cards than their maximum hand size (normally seven), they discard enough cards to reduce their hand size to that number. See rule 514.1.
703.4r Immediately after the active player has discarded cards (if necessary) during the cleanup step, all damage is removed from permanents and all “until end of turn” and “this turn” effects end. These actions happen simultaneously. See rule 514.2.
703.4s When each step or phase ends, any unused mana left in a player's mana pool empties. See rule 500.4.

704. State-Based Actions
704.1. State-based actions are game actions that happen automatically whenever certain conditions (listed below) are met. State-based actions don't use the stack.
704.1a Abilities that watch for a specified game state are triggered abilities, not state-based actions. (See rule 603, “Handling Triggered Abilities.”)
704.2. State-based actions are checked throughout the game and are not controlled by any player.
704.3. Whenever a player would get priority (see rule 117, “Timing and Priority”), the game checks for any of the listed conditions for state-based actions, then performs all applicable state-based actions simultaneously as a single event. If any state-based actions are performed as a result of a check, the check is repeated; otherwise all triggered abilities that are waiting to be put on the stack are put on the stack, then the check is repeated. Once no more state-based actions have been performed as the result of a check and no triggered abilities are waiting to be put on the stack, the appropriate player gets priority. This process also occurs during the cleanup step (see rule 514), except that if no state-based actions are performed as the result of the step's first check and no triggered abilities are waiting to be put on the stack, then no player gets priority and the step ends.
704.4. Unlike triggered abilities, state-based actions pay no attention to what happens during the resolution of a spell or ability.
    Example: A player controls a creature with the ability “This creature's power and toughness are each equal to the number of cards in your hand” and casts a spell whose effect is “Discard your hand, then draw seven cards.” The creature will temporarily have toughness 0 in the middle of the spell's resolution but will be back up to toughness 7 when the spell finishes resolving. Thus the creature will survive when state-based actions are checked. In contrast, an ability that triggers when the player has no cards in hand goes on the stack after the spell resolves, because its trigger event happened during resolution.
704.5. The state-based actions are as follows:
704.5a If a player has 0 or less life, that player loses the game.
704.5b If a player attempted to draw a card from a library with no cards in it since the last time state-based actions were checked, that player loses the game.
704.5c If a player has ten or more poison counters, that player loses the game. Ignore this rule in Two-Headed Giant games; see rule 704.6b instead.
704.5d If a token is in a zone other than the battlefield, it ceases to exist.
704.5e If a copy of a spell is in a zone other than the stack, it ceases to exist. If a copy of a card is in any zone other than the stack or the battlefield, it ceases to exist.
704.5f If a creature has toughness 0 or less, it's put into its owner's graveyard. Regeneration can't replace this event.
704.5g If a creature has toughness greater than 0, it has damage marked on it, and the total damage marked on it is greater than or equal to its toughness, that creature has been dealt lethal damage and is destroyed. Regeneration can replace this event.
704.5h If a creature has toughness greater than 0, and it's been dealt damage by a source with deathtouch since the last time state-based actions were checked, that creature is destroyed. Regeneration can replace this event.
704.5i If a planeswalker has loyalty 0, it's put into its owner's graveyard.
704.5j If two or more legendary permanents with the same name are controlled by the same player, that player chooses one of them, and the rest are put into their owners' graveyards. This is called the “legend rule.”
704.5k If two or more permanents have the supertype world, all except the one that has had the world supertype for the shortest amount of time are put into their owners' graveyards. In the event of a tie for the shortest amount of time, all are put into their owners' graveyards. This is called the “world rule.”
704.5m If an Aura is attached to an illegal object or player, or is not attached to an object or player, that Aura is put into its owner's graveyard.
704.5n If an Equipment or Fortification is attached to an illegal permanent or to a player, it becomes unattached from that permanent or player. It remains on the battlefield.
704.5p If a battle or creature is attached to an object or player, it becomes unattached and remains on the battlefield. Similarly, if any nonbattle, noncreature permanent that's neither an Aura, an Equipment, nor a Fortification is attached to an object or player, it becomes unattached and remains on the battlefield.
704.5q If a permanent has both a +1/+1 counter and a -1/-1 counter on it, N +1/+1 and N -1/-1 counters are removed from it, where N is the smaller of the number of +1/+1 and -1/-1 counters on it.
704.5r If a permanent with an ability that says it can't have more than N counters of a certain kind on it has more than N counters of that kind on it, all but N of those counters are removed from it.
704.5s If the number of lore counters on a Saga permanent is greater than or equal to its final chapter number and it isn't the source of a chapter ability that has triggered but not yet left the stack, that Saga's controller sacrifices it. See rule 714, “Saga Cards.”
704.5t If a player's venture marker is on the bottommost room of a dungeon card, and that dungeon card isn't the source of a room ability that has triggered but not yet left the stack, the dungeon card's owner removes it from the game. See rule 309, “Dungeons.”
704.5u If a permanent with space sculptor and any creatures without a sector designation are on the battlefield, each player who controls one or more of those creatures and doesn't control a permanent with space sculptor chooses a sector designation for each of those creatures they control. Then, each other player who controls one or more of those creatures chooses a sector designation for each of those creatures they control. See rule 702.158, “Space Sculptor.”
704.5v If a battle has defense 0 and it isn't the source of an ability that has triggered but not yet left the stack, it's put into its owner's graveyard.
704.5w If a battle has no player in the game designated as its protector and no attacking creatures are currently attacking that battle, that battle's controller chooses an appropriate player to be its protector based on its battle type. If no player can be chosen this way, the battle is put into its owner's graveyard. See rule 310, “Battles.”
704.5x If a Siege's controller is also its designated protector, that player chooses an opponent to become its protector. If no player can be chosen this way, the battle is put into its owner's graveyard. See rule 310, “Battles.”
704.5y If a permanent has more than one Role controlled by the same player attached to it, each of those Roles except the one with the most recent timestamp is put into its owner's graveyard.
704.6. Some variant games include additional state-based actions that aren't normally applicable:
704.6a In a Two-Headed Giant game, if a team has 0 or less life, that team loses the game. See rule 810, “Two-Headed Giant Variant.”
704.6b In a Two-Headed Giant game, if a team has fifteen or more poison counters, that team loses the game. See rule 810, “Two-Headed Giant Variant.”
704.6c In a Commander game, a player who's been dealt 21 or more combat damage by the same commander over the course of the game loses the game. See rule 903, “Commander.”
704.6d In a Commander game, if a commander is in a graveyard or in exile and that object was put into that zone since the last time state-based actions were checked, its owner may put it into the command zone. See rule 903, “Commander.” 
704.6e In an Archenemy game, if a non-ongoing scheme card is face up in the command zone, and no triggered abilities of any scheme are on the stack or waiting to be put on the stack, that scheme card is turned face down and put on the bottom of its owner's scheme deck. See rule 904, “Archenemy.”
704.6f In a Planechase game, if a phenomenon card is face up in the command zone, and it isn't the source of a triggered ability that has triggered but not yet left the stack, the planar controller planeswalks. See rule 901, “Planechase.”
704.7. If multiple state-based actions would have the same result at the same time, a single replacement effect will replace all of them.
    Example: You control Lich's Mirror, which says “If you would lose the game, instead shuffle your hand, your graveyard, and all permanents you own into your library, then draw seven cards and your life total becomes 20.” There's one card in your library and your life total is 1. A spell causes you to draw two cards and lose 2 life. The next time state-based actions are checked, you'd lose the game due to rule 704.5a and rule 704.5b. Instead, Lich's Mirror replaces that game loss and you keep playing.
704.8. If a state-based action results in a permanent leaving the battlefield at the same time other state-based actions were performed, that permanent's last known information is derived from the game state before any of those state-based actions were performed.
    Example: You control Young Wolf, a 1/1 creature with undying, and it has a +1/+1 counter on it. A spell puts three -1/-1 counters on Young Wolf. Before state-based actions are performed, Young Wolf has one +1/+1 counter and three -1/-1 counters on it. After state-based actions are performed, Young Wolf is in the graveyard. When it was last on the battlefield, it had a +1/+1 counter on it, so undying will not trigger.
    
EXAMPLE USER QUESTION:
Ulalek is already on the battlefield. I cast some Edrazi spell, opponent counters said eldrazi spell, i then pay 2C to copy eldrazi spells on the stack. Illegal, correct?
Ulalek reads, "Whenever you cast an eldrazi spell, you may pay 2C…" My question is: must I pay 2C exactly when I cast the eldrazi spell (anticipating a possible counterspell), or can I pay 2C in response to the counterspell to make a copy of the spell on the stack and keep the token copy?
My understanding is that the eldrazi spell will be at the bottom of the stack with Ulalek's triggered ability on top. If I choose to not pay 2C, then my opponent can counter the eldrazi spell and I have missed my chance to pay 2C for Ulalek's trigger. Is that correct?
END USER QUESTION

The information you have to solve the problem looks like this:
{
"card_name": "Ulalek",
"oracle_text": "Whenever you cast an Eldrazi spell, you may pay ColorlessColorless. If you do, copy all spells you control, then copy all other activated and triggered abilities you control. You may choose new targets for the copies. (Mana abilities can't be copied.)"
"rulings": [
    "Ulalek must be on the battlefield in order for its triggered ability to trigger. Casting Ulalek itself won't cause that ability to trigger.",
    "Each copy will have the same targets as the spell or ability it's copying unless you choose new ones. You may change any number of the targets, including all of them or none of them. If the spell is a permanent spell with targets, such as an Aura, you may also choose a new target for that spell. The new targets must be legal. If, for any target, you can't choose a new legal target, then it remains unchanged (even if the current target is illegal).",
    "The copies are created on the stack, so they're not 'cast' or 'activated.' Creating the copies won't cause abilities that trigger when a player casts a spell or activates an ability to trigger. Abilities of copied spells that say 'When you cast [this spell]' won't trigger.",
    "If the spell or ability that's copied is modal (that is, it says 'Choose one —' or the like), the copy will have the same mode or modes. You can't choose different ones.",
    "If the spell or ability that's copied has an X whose value was determined as it was cast or activated, the copy will have the same value of X.",
    "If the spell or ability that's copied has damage divided as it was cast or activated, the division can't be changed (although the targets receiving that damage still can). The same is true of spells and abilities that distribute counters.",
    "The controller of a copy can't choose to pay any alternative or additional costs for the copy. However, effects based on any alternative or additional costs that were paid for the original spell are copied as though those same costs were paid for the copy.",
    "Resolving copies of permanent spells become tokens as they enter the battlefield. These tokens are not considered 'created' when this happens.",
    "A card with devoid is just colorless. It's not colorless and the colors of mana in its mana cost.",
    "Other cards and abilities can give a card with devoid a color. If that happens, it's just the new color, not that color and colorless.",
    "Devoid works in all zones, not just on the battlefield.",
    "If a card loses devoid, it will still be colorless. This is because effects that change an object's color (like the one created by devoid) are considered before the object loses devoid.",
    "Devoid doesn't affect the color identity of the card for the purposes of the Commander variant. For example, while Abstruse Appropriation is colorless because it has devoid, its color identity is still white and black, and it can't be included in a Commander deck where the commander's color identity doesn't include both white and black."
]
}

You will output your assumptions and an array of states for each scenario. If multiple scenarios are described, output them as separate objects.

ASSUMPTIONS
Assume phase is Main phase 1 or main phase 2, because player is casting an Eldrazi spell and we don't have reason to believe it has flash.
Assume no creatures on battlefield other than those mentioned.
Assume the nondescript Eldrazi spell has no special abilities such as cast triggers since they weren't mentioned and the name of the creature spell was not given. Ex Eldrazi Displacer.
Assume that the counterspell mentioned is an average counterspell that counters a target spell, ex Counterspell.
STATE 1 CAST ELDRAZI SPELL
{
    battlefield: ["Ulalek"],
    stack: ["Eldrazi Displacer"],
    step: "main phase 1"
}
STATE 2 TRIGGER ULALEK
{
    battlefield: ["Ulalek"],
    stack: ["Eldrazi displacer", "Ulalek's triggered ability"],
    step: "main phase 1"
}
STATE 3 OPPONENT CAST COUNTERSPELL
{
    battlefield: ["Ulalek"],
    stack: ["Eldrazi displayer", "Ulalezi's triggered ability", "counterspell"],
    step: "main phase 1"
}
STATE 4 RESOLVE COUNTERSPELL
{
    battlefield: ["Ulalek"],
    stack: ["Ulalezi's triggered ability"],
    step: "main phase 1"
}

EXAMPLE USER QUESTION 2:
So I'm just trying to wrap my head around [[Magar of the Magic Strings]].
With multiple spell creatures hitting at once, all of their abilities trigger and get put on the stack at the same time and I order them as I choose ... But say I'm trying to use spells that target other spells...for copying or whatever, am I right that those won't work cause the other things on the stack arent spells yet but still just abilities that let me copy the spell? I know there's spells that make a delayed trigger that'll say something like "copy the next spell you cast" ... But for this "copy target spell" type effects won't have a legal target right? Or is there some way to order triggers that I can work around this(sorry for rambling messy questions)
END USER QUESTION 2

{
"card_name": "Magar of the Magic Strings",
"oracle_text": "1BlackRed: Note the name of target instant or sorcery card in your graveyard and put it onto the battlefield face down. It's a 3/3 creature with "Whenever this creature deals combat damage to a player, you may create a copy of the card with the noted name. You may cast the copy without paying its mana cost" and "If this creature would leave the battlefield, exile it instead of putting it anywhere else.",
"rulings": [
    "The face-down creature has no characteristics other than the ones given to it by Magar's ability. It has no name, no mana cost, no creature types, and no abilities other than the two Magar gives it. The creature is colorless and has a mana value of 0.",
    "You may look at face-down permanents you control at any time.",
    "If a face-down permanent you control leaves the battlefield, or if the game ends or you leave the game while you control it, you must reveal it to all players (even though in this case, everyone saw it before it entered).",
    "If a creature enters the battlefield as a copy of a face-down creature (or if a token is created that's a copy of one), that copy has the same characteristics as the face-down creature (in this case, it's a 3/3 creature with the two abilities and no other characteristics), even though the copy is face up. Importantly, the noted name is not part of the face-down creature's copiable values, so copies of the face-down creature won't know the noted name. If one deals combat damage to a player, its controller won't create a copy of any card.",
    "You must ensure that your face-down spells and permanents can easily be differentiated from each other. You're not allowed to mix up the cards that represent them on the battlefield to confuse other players. The order they entered the battlefield should remain clear. Common methods for indicating this include using markers or dice, or simply placing them in order on the battlefield. You must also track how each became face down (Magar's ability, cast face down using the morph ability, and so on).",
    "There are no cards in this set that would turn a face-down instant or sorcery card on the battlefield face up, but some older cards can try to do this. If something tries to turn a face-down instant or sorcery card on the battlefield face up, reveal that card to show all players it's an instant or sorcery card. The permanent remains on the battlefield face down. Abilities that trigger when a permanent turns face up won't trigger, because even though you revealed the card, it never turned face up.",
    "If an effect tries to 'blink' a face-down instant or sorcery card—that is, exile it and then return it to the battlefield—the card is exiled and remains in exile.
]
}

Create 2 scenarios to illustrate the problem.

ASSUMPTIONS
Multiple instant or sorcery face-down creatures created by Magar of the Magic Strings will be on the battlefield.
One of the instants that is a face-down creature creates copies of a target instant or sorcery.
Assume generic spells, Ex. Fork for the copier, Ponder for the spell to be copied.

STATE 1 COMBAT DAMAGE DEALT
{
    battlefield: ["Face-down ponder creature", "Face-down fork creature"],
    stack: ["Triggered ability of Face-down ponder creature", "Triggered ability of Face-down fork creature"]
    step: "combat damage"
}

STATE 2 TRIGGERED ABILITY OF FORK CREATURE RESOLVES
{
    battlefield: ["Face down ponder creature", "Face down fork creature"],
    stack: ["Triggered ability of Face down ponder creature", "Copy of Fork"]
    step: "combat damage"
}

STATE 3 COPY OF FORK RESOLVES
{
    battlefield: ["Face down ponder creature", "Face down fork creature"],
    stack: ["Triggered ability of Face down ponder creature"]
    step: "combat damage"
}

STATE 4 TRIGGERED ABILITY OF PONDER CREATURE RESOLVES
{
    battlefield: ["Face down ponder creature", "Face down fork creature"],
    stack: ["Copy of Ponder"]
    step: "combat damage"
}

STATE 5 COPY OF PONDER RESOLVES


                Provide a JSON representation, using logical defaults where needed. Be detailed and accurate."""

        response = self.model.invoke([
            SystemMessage(content=system_prompt),
            HumanMessage(content=query)
        ])

        try:
            return json.loads(response.content)
        except json.JSONDecodeError:
            print('Failed to parse LLM response as JSON:', response.content)
            return {"error": "Failed to construct valid game state"}
